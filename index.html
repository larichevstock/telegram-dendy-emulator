<!DOCTYPE html>
<html>
<head>
    <title>Dendy Emulator для Telegram</title>
<meta charset="UTF-8">    
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>

/* CSS для кнопок избранного */
.favorite-button {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.5);
    color: #ccc;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    z-index: 10;
    transition: all 0.2s;
}

.favorite-button.add-favorite:hover {
    color: #FFD700;
}

.favorite-button.remove-favorite {
    color: #FFD700;
}

.favorite-button.remove-favorite:hover {
    background-color: rgba(255, 0, 0, 0.7);
    color: white;
}

.retro-game-card {
    position: relative; /* Для правильного позиционирования кнопки избранного */
}

/* Стили для кнопки избранного на странице игры */
#game-page-favorite-btn {
    position: relative; /* Сбросим absolute позиционирование */
    top: auto;
    right: auto;
    width: 30px;
    height: 30px;
    font-size: 20px;
    margin-right: 10px; /* Отступ от жанра справа */
    margin-left: auto; /* Прижимаем к правому краю между кнопкой назад и жанром */
}

/* Стили для контейнера заголовка на странице игры */
.game-page-header {
    width: 100%;
    display: flex;
    justify-content: flex-start; /* Изменим с space-between на flex-start */
    align-items: center;
    margin-bottom: 15px;
}

/* Стили для жанра, чтобы он не прижимался к правому краю */
.game-page-genre {
    margin-left: 0; /* Убираем auto margin */
}        

/* Основные стили */
        body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #282c34; color: #ffffff; overflow-x: hidden; }
        .retro-container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 15px; box-sizing: border-box; }
        /* Заголовок */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: linear-gradient(90deg, #ff0080, #ff8c00); border-radius: 12px; padding: 10px 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .logo { display: flex; align-items: center; } .logo img { width: 50px; height: 50px; border-radius: 50%; margin-right: 10px; border: 2px solid #fff; } .logo-text { font-family: 'Press Start 2P', cursive; color: #fff; text-shadow: 2px 2px 0 #000; } .logo-text h1 { margin: 0; font-size: 1.5em; } .logo-text p { margin: 5px 0 0 0; font-size: 0.8em; } .navigation { display: flex; gap: 10px; } .nav-button { background-color: rgba(0,0,0,0.3); color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.2s; } .nav-button:hover { background-color: rgba(0,0,0,0.5); transform: scale(1.1); }
        /* Поисковая строка */
        .search-container { position: relative; margin-bottom: 20px; max-width: 1200px; width: 100%; margin-left: auto; margin-right: auto; } .search-input { width: 100%; padding: 15px 45px 15px 20px; border: none; border-radius: 25px; background-color: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.3s; box-sizing: border-box; } .search-input:focus { outline: none; background-color: rgba(255, 255, 255, 0.15); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); } .search-button { position: absolute; right: 5px; top: 5px; background: linear-gradient(90deg, #ff0080, #ff8c00); color: #fff; border: none; border-radius: 20px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.2s; } .search-button:hover { transform: scale(1.05); }
        /* Категории */
        .categories { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; } .category-card { background: linear-gradient(135deg, #1e2033, #373b59); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); overflow: hidden; position: relative; } .category-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3); } .category-icon { font-size: 36px; margin-bottom: 10px; position: relative; z-index: 1; } .category-icon img { width: 60px; height: 60px; object-fit: contain; } .category-title { font-family: 'Press Start 2P', cursive; font-size: 14px; color: #fff; text-shadow: 1px 1px 0 #000; margin: 0; position: relative; z-index: 1; line-height: 1.3; word-break: break-word; } .category-card::after { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(255, 0, 128, 0.1), rgba(255, 140, 0, 0.1)); z-index: 0; opacity: 0; transition: opacity 0.3s; } .category-card:hover::after { opacity: 1; }
        /* Большие карточки */
        .featured-games { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; } .featured-card { background: linear-gradient(135deg, #373b59, #1e2033); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; } .featured-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3); } .featured-content { position: relative; z-index: 1; flex-grow: 1; } .featured-title { font-family: 'Press Start 2P', cursive; font-size: 16px; color: #fff; text-shadow: 1px 1px 0 #000; margin: 0 0 30px 0; } .featured-image { width: 100%; height: 120px; object-fit: contain; margin-top: auto; } .arrow-button {
    position: absolute;
    right: 15px !important; /* Фиксированное расстояние от правого края */
    bottom: 10px; /* Положение снизу */
    background: linear-gradient(90deg, #ff0080, #ff8c00);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    text-shadow: 0px 1px 1px rgba(0,0,0,0.3); /* Добавляем тень для визуального эффекта */
    transition: all 0.2s;
    z-index: 2;
}

/* Специальное правило для стрелки в новостном баннере */
.news-banner .arrow-button {
    bottom: auto; /* Сбрасываем отступ снизу */
    top: 50%; /* Центрируем по вертикали */
    transform: translateY(-50%); /* Центрируем точно по вертикали */
}

.news-banner .arrow-button:hover {
    transform: translateY(-50%) scale(1.1); /* Сохраняем центрирование при hover */
}

/* Перезаписываем все стили для news-banner */
.news-banner {
    position: relative; /* Убедимся, что родитель имеет relative */
}

.news-banner .arrow-button {
    position: absolute;
    bottom: 10px; 
    right: 15px; /* Должен быть точно такой же как выше */
}

/* Также фиксируем позицию для .featured-card */
.featured-card {
    position: relative; /* Убедимся, что родитель имеет relative */
}

.featured-card .arrow-button {
    position: absolute;
    bottom: 10px;
    right: 15px; /* Должен быть точно такой же как выше */
}

.arrow-button:hover {
    transform: scale(1.1);
}

/* Применяем точное позиционирование для стрелки в новостях */
.news-banner .arrow-button {
    right: 20px !important; /* Использование important для перезаписи любых других стилей */
}

/* Специфический стиль для кнопки в блоке новостей */
.news-banner .arrow-button {
    bottom: auto; /* Сбрасываем позицию bottom */
    top: 50%;    /* Центрируем по вертикали */
    transform: translateY(-50%); /* Смещаем для точного центрирования */
    right: 10px; /* Такой же отступ справа как у других кнопок */
}

.news-banner .arrow-button:hover {
    transform: translateY(-50%) scale(1.1); /* Сохраняем центрирование и добавляем эффект увеличения */
}

/* Для мобильных устройств */
@media (max-width: 600px) {
    .news-banner .arrow-button {
        top: auto; /* Отменяем центрирование по вертикали */
        bottom: 10px; /* Возвращаем позиционирование снизу */
        transform: none; /* Сбрасываем трансформацию */
    }
    
    .news-banner .arrow-button:hover {
        transform: scale(1.1); /* Обновляем эффект hover */
    }
}
        /* Секция 8-bit Хиты и сетка игр */
        .retro-hits { margin-bottom: 20px; } .retro-hits-title { font-family: 'Press Start 2P', cursive; font-size: 18px; color: #fff; text-shadow: 1px 1px 0 #000; margin: 0 0 15px 0; text-align: center; } .retro-games-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; } .retro-game-card { background: linear-gradient(135deg, #1e2033, #373b59); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); overflow: hidden; } .retro-game-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3); } .retro-game-image { display: block; width: 100%; max-width: 90px; height: auto; object-fit: contain; margin-bottom: 8px; border-radius: 8px; background-color: rgba(0,0,0,0.1); } .retro-game-title { font-family: 'Press Start 2P', cursive; font-size: 12px; color: #fff; margin: 0; line-height: 1.3; word-break: break-word; }
        /* ROM Загрузка */
        .rom-upload { background: linear-gradient(135deg, #1e2033, #373b59); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); } .rom-upload-title { font-family: 'Press Start 2P', cursive; font-size: 18px; color: #fff; text-shadow: 1px 1px 0 #000; margin: 0 0 15px 0; text-align: center; } .upload-box { width: 100%; height: 120px; border: 2px dashed #555; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.2); transition: all 0.3s; cursor: pointer; position: relative; } .upload-box:hover, .upload-box[drag] { border-color: #ff0080; background-color: rgba(0, 0, 0, 0.3); } .file-input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; } .upload-text { font-size: 16px; color: #aaa; text-align: center; padding: 0 15px; } .upload-text strong { color: #fff; display: block; margin-bottom: 5px; }
        /* Новости/Баннер */
        .news-banner { background: linear-gradient(135deg, #1e2033, #373b59); border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); } .news-banner:hover { box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3); } .news-content { position: relative; z-index: 1; display: flex; align-items: center; } .news-text { flex: 1; } .news-title { font-family: 'Press Start 2P', cursive; font-size: 16px; color: #fff; text-shadow: 1px 1px 0 #000; margin: 0 0 10px 0; } .news-description { color: rgba(255, 255, 255, 0.8); margin: 0; font-size: 14px; } .news-icon { font-size: 36px; color: #ff0080; margin-right: 15px; }
        /* Эмулятор и его управление */
        #display { width: 100%; height: calc(100vh - 160px); max-height: 600px; background-color: #000; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 20px; } #game { width: 100%; height: 100%; } #backButton { position: fixed; top: 15px; left: 15px; background-color: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 1002; font-size: 22px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background-color: transparent; } #backButton:hover { background-color: rgba(0,0,0,0.5); } #reloadEmulatorButton { position: fixed; top: 15px; right: 15px; background-color: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 1002; font-size: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } #reloadEmulatorButton:hover { background-color: rgba(0,0,0,0.5); } #orientationMessage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; box-sizing: border-box; transition: opacity 0.3s ease; -webkit-tap-highlight-color: transparent; user-select: none; } #startPlayButton { background-color: #FF0000; color: white; border: none; border-radius: 8px; padding: 15px 30px; font-size: 20px; font-weight: bold; margin-bottom: 30px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.1s ease, background-color 0.2s ease; -webkit-tap-highlight-color: transparent; } #startPlayButton:hover { background-color: #D00000; transform: translateY(2px); } .loading-state { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; } .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; } @keyframes spin { to { transform: rotate(360deg); } } .loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; display: none; } .loading-indicator::after { content: ""; width: 50px; height: 50px; border: 5px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        /* Полноэкранный режим */
        .fullscreen-mode #display { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; max-height: none !important; z-index: 1000 !important; border-radius: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden !important; background-color: #000 !important; } .fullscreen-mode #game { width: 100% !important; height: 100% !important; position: relative !important; display: flex !important; align-items: center !important; justify-content: center !important; overflow: hidden !important; background-color: #000 !important; } .fullscreen-mode #game canvas { object-fit: contain !important; max-width: 100% !important; max-height: 100% !important; width: auto !important; height: auto !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; image-rendering: pixelated !important; background-color: #000 !important; -webkit-backface-visibility: hidden !important; backface-visibility: hidden !important; } .fullscreen-mode .ejs_virtualGamepad, .fullscreen-mode .ejs_virtualGamepad_button, .fullscreen-mode .ejs_virtualGamepad_touchpad { z-index: 1002 !important; } .hidden { display: none !important; } body.touch-disabled { touch-action: none !important; -ms-touch-action: none !important; overflow: hidden !important; }
        /* Стили для секции результатов поиска, недавних игр и каталога */
        #search-results-area { padding-top: 20px; } .search-results-title { font-family: 'Press Start 2P', cursive; font-size: 18px; color: #fff; text-shadow: 1px 1px 0 #000; margin: 0 0 15px 0; text-align: center; } .back-to-main-button { display: block; margin: 20px auto 10px auto; padding: 10px 20px; font-family: 'Press Start 2P', cursive; font-size: 12px; color: #fff; background: linear-gradient(90deg, #555, #333); border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s; text-shadow: 1px 1px 0 #000; } .back-to-main-button:hover { background: linear-gradient(90deg, #666, #444); }
        /* Адаптивность */
        @media (min-width: 768px) { .categories { grid-template-columns: repeat(3, 1fr); } .retro-games-grid { grid-template-columns: repeat(4, 1fr); } } @media (max-width: 600px) { .header { flex-direction: column; text-align: center; padding: 15px; } .logo { margin-bottom: 10px; justify-content: center; } .navigation { width: 100%; justify-content: center; } .featured-games { grid-template-columns: 1fr; } .news-content { flex-direction: column; text-align: center; } .news-icon { margin: 0 0 15px 0; } .retro-games-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; } } @media (max-width: 480px) { .rom-upload-title, .retro-hits-title { font-size: 14px; } .upload-box { height: 100px; } .upload-text { font-size: 14px; } .search-results-title { font-size: 16px; } } @media (max-width: 360px) { .retro-games-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; } .retro-game-image { max-width: 70px; } .retro-game-title { font-size: 10px; } .retro-game-card { padding: 10px 5px; } .category-title { font-size: 12px; } }

/* === СТИЛИ ДЛЯ СТРАНИЦЫ ИГРЫ === */
#game-page-area {
    padding: 20px 15px;
    background-color: #1e2033; /* Немного другой фон для отличия */
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.game-page-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.game-page-header {
    width: 100%;
    display: flex;
    justify-content: space-between; /* Кнопка назад слева, жанр справа */
    align-items: center;
    margin-bottom: 15px;
}

.game-page-back-button {
    background: none;
    border: none;
    color: #ff8c00; /* Оранжевый цвет */
    font-size: 28px; /* Крупнее */
    cursor: pointer;
    padding: 5px;
    line-height: 1;
    font-weight: bold;
}
.game-page-back-button:hover {
    color: #ffae42; /* Светлее при наведении */
}


.game-page-genre {
    font-family: 'Press Start 2P', cursive;
    font-size: 12px;
    color: #aaa;
    text-transform: uppercase;
    background-color: rgba(255, 255, 255, 0.1);
    padding: 5px 10px;
    border-radius: 6px;
    margin-left: auto; /* Прижимаем вправо */
}

.game-page-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 20px; /* Крупнее */
    color: #fff;
    text-shadow: 1px 1px 0 #000;
    margin: 0 0 20px 0; /* Отступ снизу */
    line-height: 1.4;
}

.game-page-logo {
    width: 70%;           /* Увеличиваем с 60% до 70% */
    max-width: 250px;     /* Увеличиваем с 200px до 250px */
    height: auto;
    object-fit: contain;
    margin-bottom: 25px;
    border-radius: 8px;
    background-color: rgba(0,0,0,0.2);
    padding: 10px;
    box-sizing: border-box;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* Добавляем тень для лучшего вида */
}

.game-page-screenshots {
    margin-bottom: 25px;
    width: 100%;
    text-align: center;
    color: #aaa;
    font-style: italic;
}
/* Стили для реальных скриншотов (когда добавите)
.game-page-screenshots img {
    width: 48%;
    margin: 1%;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
} */

.game-page-description {
    color: #ddd;
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 30px;
    text-align: center; /* Меняем left на center */
    max-width: 600px; /* Ограничим ширину для читаемости */
    width: 100%;
    margin-left: auto; /* Добавляем для лучшего центрирования */
    margin-right: auto; /* Добавляем для лучшего центрирования */
}

.game-page-play-button {
    font-family: 'Press Start 2P', cursive;
    font-size: 18px;
    color: #fff;
    background: linear-gradient(90deg, #ff0080, #ff8c00);
    border: none;
    border-radius: 10px;
    padding: 15px 30px;
    cursor: pointer;
    text-shadow: 1px 1px 0 #000;
    transition: all 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}
.game-page-play-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(0,0,0,0.4);
}
/* === КОНЕЦ СТИЛЕЙ === */

/* === СТИЛИ ДЛЯ СПИСКА ПО АЛФАВИТУ === */
        #alpha-list-overlay {
            position: fixed; /* Фиксированное позиционирование поверх всего */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* На весь экран */
            background-color: rgba(40, 44, 52, 0.97); /* Почти непрозрачный фон */
            z-index: 1100; /* Выше других элементов интерфейса */
            padding: 15px;
            box-sizing: border-box;
            display: flex; /* Используем flex для внутренней компоновки */
            flex-direction: column;
            overscroll-behavior: contain; /* Предотвращаем прокрутку body под оверлеем */
            /* Изначально скрыт через класс .hidden */
            transition: opacity 0.3s ease; /* Плавное появление/исчезновение (если убирать/добавлять класс) */
        }

        /* Стилизация, когда оверлей видим (если используем opacity)
        #alpha-list-overlay:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        } */

        .alpha-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0; /* Заголовок не должен сжиматься */
            border-bottom: 1px solid rgba(255, 140, 0, 0.3); /* Разделитель */
            padding-bottom: 10px;
        }

        .alpha-list-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 16px; /* Чуть меньше основного заголовка */
            color: #fff;
            text-shadow: 1px 1px 0 #000;
            margin: 0;
        }

        .alpha-list-close-btn {
            background: none;
            border: none;
            color: #ff8c00; /* Оранжевый, как кнопка Назад */
            font-size: 32px; /* Крупный крестик */
            font-weight: bold;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s;
        }
        .alpha-list-close-btn:hover {
            color: #ffae42; /* Светлее при наведении */
        }

        .alpha-list-content {
            flex-grow: 1; /* Занимает всё оставшееся место */
            overflow-y: auto; /* Включает вертикальную прокрутку при необходимости */
            margin-right: -5px; /* Компенсация ширины скроллбара справа */
            padding-right: 5px; /* Компенсация ширины скроллбара справа */
             /* Стилизация скроллбара */
             scrollbar-width: thin; /* Firefox */
             scrollbar-color: #ff8c00 #555; /* Firefox - цвет ползунка и трека */
        }
        /* Стилизация скроллбара для Webkit (Chrome, Safari) */
        .alpha-list-content::-webkit-scrollbar {
          width: 8px;
        }
        .alpha-list-content::-webkit-scrollbar-track {
          background: #373b59; /* Фон трека */
          border-radius: 4px;
        }
        .alpha-list-content::-webkit-scrollbar-thumb {
          background-color: #ff8c00; /* Цвет ползунка */
          border-radius: 4px;
          border: 2px solid #373b59; /* Отступ ползунка от краев трека */
        }


        .alpha-list-item {
            display: block; /* Чтобы занимал всю ширину */
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            color: #eee; /* Светло-серый текст */
            border: none;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.2s, color 0.2s;
            box-sizing: border-box;
            font-family: inherit; /* Наследуем шрифт от body */
            line-height: 1.4;
        }

        .alpha-list-item:hover {
            background-color: rgba(255, 140, 0, 0.2); /* Оранжевый фон при наведении */
            color: #fff; /* Белый текст при наведении */
        }

        /* Добавляем стиль для класса .hidden, если его еще нет */
        .hidden {
            display: none !important;
        }
        /* === КОНЕЦ СТИЛЕЙ ДЛЯ СПИСКА ПО АЛФАВИТУ === */

/* Обновляем стили для кнопки избранного - фиксируем положение звезды */
#game-page-favorite-btn {
    position: static; 
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    font-size: 28px;
    margin: 15px auto;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    border: none;
    background: rgba(30, 30, 50, 0.3);
    z-index: 5;
    cursor: pointer;
    line-height: 0; /* Важно для центрирования */
    padding-bottom: 3px; /* Смещаем звезду немного вверх */
}

/* Стиль для неактивной звезды (добавить в избранное) */
#game-page-favorite-btn.add-favorite {
    color: rgba(255, 255, 255, 0.7);
    background: linear-gradient(45deg, rgba(20, 20, 40, 0.4), rgba(40, 40, 70, 0.5));
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
}

/* Стиль для активной звезды (уже в избранном) */
#game-page-favorite-btn.remove-favorite {
    color: #FFD700; /* Золотой цвет */
    background: linear-gradient(45deg, rgba(40, 0, 40, 0.3), rgba(80, 40, 0, 0.4));
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
}

/* Эффекты при наведении */
#game-page-favorite-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
}

#game-page-favorite-btn.add-favorite:hover {
    color: #FFD700;
    background: linear-gradient(45deg, rgba(30, 0, 30, 0.4), rgba(70, 40, 0, 0.5));
}

#game-page-favorite-btn.remove-favorite:hover {
    color: #FFF;
    background: rgba(180, 0, 0, 0.4);
}

/* Обновленная структура заголовка страницы игры */
.game-page-title-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 15px;
}

.game-page-title-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 15px;
}

.game-page-genre {
    align-self: flex-end; /* Жанр справа */
    margin-top: 5px;      /* Отступ от названия */
    margin-left: auto;    /* Прижимаем жанр вправо */
}

/* Стиль для звезды избранного в алфавитном списке */
.alpha-list-item .favorite-indicator {
    display: inline-block;
    color: #FFD700; /* Золотой цвет */
    margin-right: 8px;
    font-size: 18px;
    vertical-align: middle;
    position: relative;
    top: -1px; /* Небольшое смещение вверх для выравнивания */
}

</style>
</head>
<body>
    <div class="retro-container" id="retro-container">
        <div class="header">
             <div class="logo"> <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjRkYwMDAwIiBkPSJNNTAsMTBjMjIuMSwwLDQwLDE3LjksNDAsNDBTNzIuMSw5MCw1MCw5MFMxMCw3Mi4xLDEwLDUwUzI3LjksMTAsNTAsMTB6Ii8+PHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0iTTM1LDM1aDMwdjMwSDM1VjM1eiIvPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjI1IiBjeT0iMzUiIHI9IjUiLz48Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSI3NSIgY3k9IjM1IiByPSI1Ii8+PGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iNzUiIGN5PSI2NSIgcj0iNSIvPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjI1IiBjeT0iNjUiIHI9IjUiLz48L3N2Zz4=" alt="Logo" /> <div class="logo-text"> <h1>Dendy</h1> <p>Ретро-эмулятор</p> </div> </div>
             <div class="navigation"> <button class="nav-button" title="Главная" id="home-nav-button">🏠</button> <button class="nav-button" title="Каталог игр">🎮</button> <button class="nav-button" title="Избранное">⭐</button> </div>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" placeholder="Поиск любимых игр..." />
            <button class="search-button">🔍</button>
        </div>

        <div id="main-content">
            <div class="categories">
                <div class="category-card" id="top-games-btn"> <div class="category-icon">🏆</div> <h3 class="category-title">ТОП ИГР</h3> </div>
                <div class="category-card" id="alpha-sort-btn"> <div class="category-icon">🔤</div> <h3 class="category-title">ПО АЛФАВИТУ</h3> </div>
                <div class="category-card" id="random-btn"> <div class="category-icon">🎲</div> <h3 class="category-title">СЛУЧАЙНАЯ</h3> </div>
                <div class="category-card" id="popular-btn"> <div class="category-icon">📊</div> <h3 class="category-title">ПОПУЛЯРНЫЕ</h3> </div>
                <div class="category-card" id="recent-games-btn"> <div class="category-icon">🔄</div> <h3 class="category-title">НЕДАВНИЕ</h3> </div>
                <div class="category-card" id="share-btn"> <div class="category-icon">📱</div> <h3 class="category-title">ПОДЕЛИТЬСЯ</h3> </div>
            </div>

            <div class="retro-hits">
                <h2 class="retro-hits-title">8-BIT ХИТЫ</h2>
                <div class="retro-games-grid" id="retro-games-grid"></div>
            </div>

            <div class="rom-upload">
                <h2 class="rom-upload-title">ЗАГРУЗИТЬ ROM</h2>
                <div class="upload-box" id="upload-box">
                    <input type="file" id="fileInput" accept=".nes,.fds,.unif,.unf" class="file-input">
                    <div class="upload-text"> <strong>Загрузите ROM-файл</strong> Перетащите файл или нажмите здесь </div>
                </div>
            </div>

            <div class="featured-games">
                 <div class="featured-card"> <div class="featured-content"> <h3 class="featured-title">ПРОДОЛЖИТЬ ИГРУ</h3> <img src="data/img/next.png" alt="ПРОДОЛЖИТЬ ИГРУ" class="featured-image"> </div> <button class="arrow-button">➜</button> </div>
                 <div class="featured-card" id="catalog-btn"> <div class="featured-content"> <h3 class="featured-title">КАТАЛОГ ИГР</h3> <img src="data/img/catalog.png" alt="Dendy каталог" class="featured-image"> </div> <button class="arrow-button">➜</button> </div>
            </div>

            <div class="news-banner">
                 <div class="news-content">
                     <div class="news-icon">📰</div>
                     <div class="news-text">
                         <h3 class="news-title">НОВОСТИ И ОБНОВЛЕНИЯ</h3>
                         <p class="news-description">Следите за обновлениями и новыми играми в нашем канале!</p>
                     </div>
                     </div>
                 <button class="arrow-button">➜</button> </div>
        </div> 
        
        <div id="search-results-area" class="hidden"></div>

        <div id="game-page-area" class="hidden">
        </div>
        <div id="display" class="hidden"> <div id="game"></div> </div>

    </div> 
    <button id="backButton">&#10229;</button>
    <button id="reloadEmulatorButton">↻</button>

    <div id="orientationMessage"> <button id="startPlayButton">Начать играть</button> <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M17 2H7C5.9 2 5 2.9 5 4v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path> <path d="M12 18h.01"></path> </svg> <h2 style="margin: 15px 0;">Для лучшего опыта</h2> <p style="font-size: 16px; margin: 0 0 20px 0;">Поверните устройство в горизонтальное положение</p> </div>
    <div id="loadingState" class="loading-state"> <div class="loading-spinner"></div> <p>Перезагрузка эмулятора...</p> </div>
    <div id="loadingIndicator" class="loading-indicator"></div>

    <!-- Контейнер для алфавитного списка -->
    <div id="alpha-list-overlay" class="hidden">
        <div class="alpha-list-header">
            <h2 class="alpha-list-title">Поиск по алфавиту</h2>
            <button class="alpha-list-close-btn" title="Закрыть">&times;</button>
        </div>
        <div class="alpha-list-content">
            <!-- Здесь будет генерироваться список игр по алфавиту -->
        </div>
    </div>

    <script>

// Функция для определения папки EJS
window.EJS_pathtodata = "./data/"; // путь к папке с ядрами

// Функция для работы с избранными играми
const favoritesManager = {
    // Получить список избранных игр
    getFavorites: function() {
        try {
            return JSON.parse(localStorage.getItem('favoriteGames') || '[]');
        } catch (e) {
            console.error("Ошибка при получении избранных игр:", e);
            return [];
        }
    },

    // Добавить игру в избранное (исходная функция)
    originalAddToFavorites: function(game) {
        try {
            const favorites = this.getFavorites();
            // Проверяем, нет ли уже такой игры в избранном
            if (!favorites.some(g => g.id === game.id)) {
                favorites.push({
                    id: game.id,
                    title: game.title,
                    romUrl: game.romUrl || `roms/catalog/${game.filename}`,
                    genre: game.genre || 'Неизвестно'
                });
                localStorage.setItem('favoriteGames', JSON.stringify(favorites));
                return true;
            }
            return false;
        } catch (e) {
            console.error("Ошибка при добавлении в избранное:", e);
            return false;
        }
    },

     // Переопределенная функция добавления в избранное (для достижений)
     addToFavorites: function(game) {
        const result = this.originalAddToFavorites(game); // Вызываем оригинальную функцию
        if (result && game && game.id) { // Если добавление успешно
            // Создаем событие для системы достижений
            const favoriteEvent = new CustomEvent('favoriteAdded', {
                detail: { gameId: game.id, gameTitle: game.title }
            });
            document.dispatchEvent(favoriteEvent); // Отправляем событие
            console.log("AchievementSystem: favoriteAdded event dispatched for", game.id); // Отладка
        }
        return result;
     },


    // Удалить игру из избранного
    removeFromFavorites: function(gameId) {
        try {
            let favorites = this.getFavorites();
            favorites = favorites.filter(g => g.id !== gameId);
            localStorage.setItem('favoriteGames', JSON.stringify(favorites));
            return true;
        } catch (e) {
            console.error("Ошибка при удалении из избранного:", e);
            return false;
        }
    },

    // Проверить, находится ли игра в избранном
    isInFavorites: function(gameId) {
        try {
            const favorites = this.getFavorites();
            return favorites.some(g => g.id === gameId);
        } catch (e) {
            console.error("Ошибка при проверке избранного:", e);
            return false;
        }
    }
};

        const enableDebug = false; const enableThreads = false; const defaultCore = "nes";
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // --- Глобальные переменные для хранения списков игр ---
        window.libraryGames = []; // Будет заполнено ниже
        window.fullCatalogGames = []; // Будет заполнено ниже

        document.addEventListener('DOMContentLoaded', function() {
            // Элементы интерфейса
            const fileInput = document.getElementById('fileInput');
            const uploadBox = document.getElementById('upload-box');
            const display = document.getElementById('display');
            const backButton = document.getElementById('backButton');
            const reloadEmulatorButton = document.getElementById('reloadEmulatorButton');
            const startPlayButton = document.getElementById('startPlayButton');
            const orientationMessage = document.getElementById('orientationMessage');
            const loadingState = document.getElementById('loadingState');
            const mainContent = document.getElementById('main-content');
            const initialRetroGamesGrid = document.getElementById('retro-games-grid');
            const searchInput = document.querySelector('.search-input');
            const searchButton = document.querySelector('.search-button');
            const searchResultsArea = document.getElementById('search-results-area');
            const recentGamesButton = document.getElementById('recent-games-btn');
            const homeNavButton = document.getElementById('home-nav-button');
            const shareButton = document.getElementById('share-btn');
            const alphaSortButton = document.getElementById('alpha-sort-btn');
            const catalogButton = document.getElementById('catalog-btn');
            const popularButton = document.getElementById('popular-btn');
            const randomButton = document.getElementById('random-btn'); // --- СЛУЧАЙНАЯ ИГРА
            const catalogNavButton = document.querySelector('.navigation .nav-button[title="Каталог игр"]');
            const topGamesButton = document.getElementById('top-games-btn'); // --- ТОП ИГР ---
            const favoritesNavButton = document.querySelector('.navigation .nav-button[title="Избранное"]'); // Избранное

            // Элементы для алфавитного списка
            const alphaListOverlay = document.getElementById('alpha-list-overlay');
            const alphaListContent = alphaListOverlay ? alphaListOverlay.querySelector('.alpha-list-content') : null;
            const alphaListCloseBtn = alphaListOverlay ? alphaListOverlay.querySelector('.alpha-list-close-btn') : null;

            // Список игр для "8-BIT ХИТЫ"
            const initialLibraryGames = [
                { id: "mario", title: "Super Mario Bros", romUrl: "roms/Mario.nes" },
                { id: "contra", title: "Contra", romUrl: "roms/Contra.nes" },
                { id: "battle_city", title: "Battle City", romUrl: "roms/Battle City.nes" },
                { id: "duck_hunt", title: "Duck Hunt", romUrl: "roms/Duck Hunt.nes" },
                { id: "tetris", title: "Tetris", romUrl: "roms/Tetris.nes" },
                { id: "ninja_gaiden", title: "Ninja Gaiden", romUrl: "roms/Ninja Gaiden.nes" }
            ];

            const generateId = (filename) => {
                let namePart = filename.split('.').slice(0, -1).join('.');
                // Удаляем префиксы типа 'onlain-igrok.rf_' и цифры в начале, если есть
                namePart = namePart.replace(/^(onlain-igrok\.rf_\d+_|onlain-igrok\.rf_|487_)/, '');
                return namePart.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, ''); // Убираем подчеркивания в начале/конце
            };


            const gameDetailsData = {
                 "Super Mario Bros": { genre: "Платформер", description: "Классика платформеров. Помоги Марио спасти принцессу, преодолевая врагов и ловушки в волшебном мире."},
                 "Contra": { genre: "Экшен", description: "Взрывной боевик. Пройди огонь и воду в роли элитного бойца, сражаясь с пришельцами и роботами."},
                 "Battle City": { genre: "Аркада", description: "Защити свою базу. Управляй танком, уничтожай врагов и строй укрепления на пути к победе."},
                 "Duck Hunt": { genre: "Шутер (Light Gun)", description: "Охота начинается. Прицелься и стреляй по уткам с помощью светового пистолета."},
                 "Tetris": { genre: "Пазл", description: "Головоломка на века. Составляй линии из падающих фигур и не дай экрану заполниться."},
                 "Ninja Gaiden": { genre: "Платформер/Экшен", description: "Стань тенью. Управляй ниндзя Рю и побеждай врагов в насыщенном экшен-платформере с сюжетом."},
                 "Teenage Mutant Ninja Turtles III: The Manhattan Project": { genre: "Экшен", description: "Черепахи снова в деле! Спаси Нью-Йорк от злодея Шреддера и его армии. Игра для одного или двух игроков с динамичным геймплеем, разнообразными врагами и боссами."},
                 "Battletoads & Double Dragon": { genre: "Экшен", description: "Крутой кроссовер легендарных героев! Сражайся против космических злодеев, используя мощные удары и комбо. Превосходный геймплей и яркая графика."},
                 "Battletoads (Русская версия)": { genre: "Экшен", description: "Знаменитые боевые жабы идут на бой со злом! Экшен с разнообразными уровнями, сложными противниками и напряжённым геймплеем. Идеальна для игры вдвоём."},
                 "Bucky O'Hare": { genre: "Экшен", description: "Космический кролик Баки и его команда в опасном приключении! Сложные уровни, разнообразные герои и захватывающий сюжет делают игру культовой."},
                 "Captain America and the Avengers": { genre: "Экшен", description: "Присоединяйся к команде Мстителей и спаси мир от суперзлодеев. Игра с множеством персонажей и активным экшеном."},
                 "Contra Force": { genre: "Экшен", description: "Знаменитая серия Contra возвращается! Уничтожай врагов, используй разные виды оружия и координируй действия команды бойцов."},
                 "Jackal": { genre: "Экшен", description: "Военный экшен, где ты управляешь джипом и спасаешь заложников. Множество врагов и непростые миссии делают игру увлекательной и динамичной."},
                 "Monster in My Pocket": { genre: "Экшен", description: "Сражения миниатюрных монстров в обычном доме! Динамичный экшен с яркой графикой и разнообразием уровней."},
                 "RoboCop": { genre: "Экшен", description: "Знаменитый робот-полицейский борется с преступностью. Суровые сражения, жестокие враги и увлекательные уровни."},
                 "RoboCop 2": { genre: "Экшен", description: "Продолжение борьбы Робокопа с преступностью. Новые враги и уровни."},
                 "RoboCop 3": { genre: "Экшен", description: "Робокоп снова на страже закона. Третья часть саги с улучшенной графикой и геймплеем."},
                 "Shadow of the Ninja": { genre: "Экшен", description: "Экшен о бесстрашных ниндзя, сражающихся против сил зла. Отличная графика, плавный геймплей и захватывающие уровни."},
                 "Silkworm": { genre: "Экшен", description: "Динамичный экшен с вертолётом и джипом, сражающимися против бесчисленных противников. Кооперативный режим для двух игроков."},
                 "Super C (Super Contra)": { genre: "Экшен", description: "Продолжение знаменитой Contra с ещё большим количеством врагов, оружия и эпичных боссов."},
                 "Tokkyuu Shirei Solbrain": { genre: "Экшен", description: "Японский супергерой спасает город от злодеев. Классический экшен в лучших традициях японских боевиков."},
                 "S.C.A.T.: Special Cybernetic Attack Team": { genre: "Экшен", description: "Летающий экшен-платформер (Final Mission)."},
                 "Alien 3": { genre: "Экшен", description: "Экшен-платформер по мотивам фильма Чужой 3. Сложные лабиринты и опасные ксеноморфы."},
                 "Adventure Island": { genre: "Приключения", description: "Весёлые приключения парня в шапочке, сражающегося с монстрами на острове. Простое управление, много уровней и яркая графика."},
                 "Adventure Island II": { genre: "Приключения", description: "Продолжение приключений на острове с новыми динозаврами-помощниками."},
                 "Adventure Island III": { genre: "Приключения", description: "Третья часть с ещё большим разнообразием уровней и врагов."},
                 "Adventure Island IV": { genre: "Приключения", description: "Четвёртая часть, выпущенная только в Японии, с элементами RPG."},
                 "Chip 'n Dale: Rescue Rangers (Русская версия)": { genre: "Приключения", description: "Чип и Дейл в захватывающих приключениях! Увлекательный геймплей, командная игра и много секретов на уровнях."},
                 "Chip 'n Dale: Rescue Rangers 2 (Русская версия от Shedevr)": { genre: "Приключения", description: "Вторая часть приключений спасателей с новыми уровнями и возможностями."},
                 "Darkwing Duck": { genre: "Приключения", description: "Чёрный плащ выходит на защиту города от преступников. Яркие персонажи, оригинальные уровни и удобное управление."},
                 "Duck Tales": { genre: "Приключения", description: "Дядюшка Скрудж и охота за сокровищами по всему миру. Красивые уровни, увлекательные задания и множество секретов."},
                 "DuckTales 2": { genre: "Приключения", description: "Продолжение охоты Скруджа за сокровищами с новыми локациями."},
                 "Felix the Cat": { genre: "Приключения", description: "Весёлое приключение легендарного кота. Используй разные способности Феликса, чтобы пройти через все уровни."},
                 "Prince of Persia (Русская версия)": { genre: "Приключения", description: "Легендарное приключение принца, полный ловушек и опасностей. Отличается реалистичной анимацией и сложными загадками."},
                 "TaleSpin": { genre: "Приключения", description: "Баллу и его воздушные приключения. Полёты, сражения и интересные миссии в мире мультсериала."},
                 "The Flintstones: The Rescue of Dino & Hoppy": { genre: "Приключения", description: "Флинстоуны в доисторических приключениях. Весёлые персонажи, интересные головоломки и уровни."},
                 "The Flintstones: Surprise at Dinosaur Peak": { genre: "Приключения", description: "Вторая часть приключений Флинстоунов с новыми заданиями."},
                 "Tiny Toon Adventures": { genre: "Приключения", description: "Забавные мультгерои Tiny Toon в весёлых приключениях. Яркий мир, разнообразные уровни и простое управление."},
                 "Tiny Toon Adventures 2: Trouble in Wackyland": { genre: "Приключения", description: "Продолжение приключений Tiny Toon в парке развлечений Wackyland."},
                 "Tom and Jerry (Русская версия)": { genre: "Приключения", description: "Весёлое противостояние Тома и Джерри. Пройдите все уровни, избегая ловушек и врагов."},
                 "Batman": { genre: "Платформер/Экшен", description: "Готэм в опасности! Управляй Бэтменом, проходи сложные уровни и сражайся с культовыми злодеями."},
                 "Batman Returns": { genre: "Платформер/Экшен", description: "Битва Бэтмена против Пингвина и Женщины-кошки по мотивам фильма."},
                 "Castlevania": { genre: "Платформер/Экшен", description: "Легендарные приключения семьи Бельмонтов, сражающихся с Дракулой. Мрачная атмосфера, сложные уровни и культовый саундтрек."},
                 "Castlevania II: Simon's Quest": { genre: "Платформер/Экшен", description: "Продолжение с элементами RPG и исследованием мира."},
                 "Castlevania III: Dracula's Curse": { genre: "Платформер/Экшен", description: "Приквел с возможностью выбора персонажей и нелинейными маршрутами."},
                 "Mega Man": { genre: "Платформер/Экшен", description: "Серия игр про отважного робота. Сражайся с боссами, улучшай оружие и проходи захватывающие уровни."},
                 "Mega Man 2": { genre: "Платформер/Экшен", description: "Вторая часть приключений Мегамена с новыми боссами и способностями."},
                 "Mega Man 3": { genre: "Платформер/Экшен", description: "Мегамен 3 представляет Раша - верного пса-помощника."},
                 "Mega Man 4": { genre: "Платформер/Экшен", description: "Новый злодей и возможность заряжать выстрел Мега Бастера."},
                 "Mega Man 5": { genre: "Платформер/Экшен", description: "Брат Мегамена - Протомен - похищает доктора Лайта."},
                 "Mega Man 6": { genre: "Платформер/Экшен", description: "Мегамен получает новые адаптеры Раша для полёта и мощного удара."},
                 "Teenage Mutant Ninja Turtles (Русская версия)": { genre: "Платформер/Экшен", description: "Первая игра про черепашек на NES. Сложный платформер с видом сбоку и сверху."},
                 "Teenage Mutant Ninja Turtles II: The Arcade Game": { genre: "Платформер/Экшен", description: "Порт аркадной игры в жанре Beat 'em up. Сражайся с кланом Фут вдвоём!"},
                 "Teenage Mutant Ninja Turtles: Tournament Fighters": { genre: "Файтинг", description: "Файтинг во вселенной черепашек-ниндзя с разными бойцами и аренами."},
                 "Super Mario Bros.": { genre: "Платформер", description: "Легендарный платформер, спасший индустрию видеоигр."},
                 "Super Mario Bros. 2 (Русская версия)": { genre: "Платформер", description: "Необычная часть серии с выбором персонажей и уникальной механикой выдергивания овощей."},
                 "Super Mario Bros. 3 (Русская версия от 2R Team)": { genre: "Платформер", description: "Одна из лучших игр на NES. Огромный мир, множество бонусов и секретов."},
                 "Mario Bros.": { genre: "Аркада", description: "Классическая аркада, где Марио и Луиджи сражаются с вредителями в канализации."},
                 "Final Fantasy": { genre: "RPG", description: "Культовая серия ролевых игр с глубоким сюжетом, множеством персонажей и увлекательной системой боя."},
                 "Final Fantasy II": { genre: "RPG", description: "Вторая часть с уникальной системой прокачки, зависящей от действий персонажей."},
                 "Final Fantasy III": { genre: "RPG", description: "Третья часть с развитой системой профессий (джоб)."},
                 "Best of the Best: Championship Karate": { genre: "Файтинг", description: "Карате-чемпионат, где ты проходишь путь от новичка до чемпиона. Множество техник и реалистичные бои."},
                 "Mighty Final Fight": { genre: "Файтинг", description: "Чиби-версия знаменитого Beat 'em up Final Fight с элементами прокачки."},
                 "Double Dragon": { genre: "Файтинг", description: "Классический Beat 'em up. Братья Билли и Джимми Ли спасают Мэриан."},
                 "Double Dragon II: The Revenge": { genre: "Файтинг", description: "Продолжение Beat 'em up с новыми приёмами и улучшенной графикой."},
                 "Double Dragon III: The Sacred Stones": { genre: "Файтинг", description: "Третья часть Beat 'em up с возможностью покупки предметов и новыми бойцами."},
                 "Bomberman": { genre: "Аркада/Пазл", description: "Подрывай стены, уничтожай врагов и найди выход из лабиринта. Захватывающая аркада для одного и нескольких игроков."},
                 "Bomberman II": { genre: "Аркада/Пазл", description: "Продолжение Bomberman с новыми режимами, включая мультиплеер."},
                 "Dr. Mario (Русская версия от Multisoft)": { genre: "Пазл", description: "Затягивающая головоломка с участием Марио, где нужно очищать экран от вирусов."},
                 "Pac-Man": { genre: "Аркада", description: "Классическая аркада, где нужно съесть все точки и избежать призраков."},
                 "Lode Runner (Русская версия от Multisoft)": { genre: "Аркада/Пазл", description: "Умная аркада, где нужно собрать золото, избегая врагов и ловушек."},
                 "Blades of Steel": { genre: "Спорт", description: "Динамичный хоккей с драками и напряженными матчами."},
                 // И другие записи из вашего gameDetailsData
            };

             const initialFullCatalogGames = [
                 { filename: "teenage-manhattan.nes", title: "Teenage Mutant Ninja Turtles III: The Manhattan Project" },
                 { filename: "487_Tank_1990.nes", title: "Battle City" }, // Использует стандартное название
                 { filename: "adventure_islan.nes", title: "Adventure Island" },
                 { filename: "adventure_islan2.nes", title: "Adventure Island II" },
                 { filename: "adventure_islan3.nes", title: "Adventure Island III" },
                 { filename: "adventure_islan4.nes", title: "Adventure Island IV" },
                 { filename: "Alien 3.nes", title: "Alien 3" },
                 { filename: "Batman Returns.nes", title: "Batman Returns" },
                 { filename: "Batman.nes", title: "Batman" },
                 { filename: "Battletoads and Double Dragon.nes", title: "Battletoads & Double Dragon" }, // Скорректировано название
                 { filename: "battletoads-rus_onlain-igrok.rf_.nes", title: "Battletoads (Русская версия)" },
                 { filename: "Best of the Best - Championship Karate.nes", title: "Best of the Best: Championship Karate" },
                 { filename: "Blades_of_Steel.nes", title: "Blades of Steel" }, // Скорректировано название
                 { filename: "Bomberman (U) [T-Rus] [!].nes", title: "Bomberman" },
                 { filename: "Bomberman2.nes", title: "Bomberman II" },
                 { filename: "Bucky O'Hare.nes", title: "Bucky O'Hare" },
                 { filename: "Captain America and the Avengers.nes", title: "Captain America and the Avengers" },
                 { filename: "Castlevania 2 Simon's Quest.nes", title: "Castlevania II: Simon's Quest" },
                 { filename: "Castlevania 3 - Dracula's Curse.nes", title: "Castlevania III: Dracula's Curse" },
                 { filename: "Castlevania.nes", title: "Castlevania" },
                 { filename: "Chip n Dale Rescue Rangers 2 (U) [T-Rus] [!] by Shedevr.nes", title: "Chip 'n Dale: Rescue Rangers 2 (Русская версия от Shedevr)" },
                 { filename: "chip-n-dale-rescue-rangers-[rus].nes", title: "Chip 'n Dale: Rescue Rangers (Русская версия)" },
                 { filename: "Contra Force.nes", title: "Contra Force" },
                 { filename: "Darkwing_Duck-U-.nes", title: "Darkwing Duck" },
                 { filename: "Double Dragon II - The Revenge.nes", title: "Double Dragon II: The Revenge" },
                 { filename: "Double Dragon III - The Sacred Stones.nes", title: "Double Dragon III: The Sacred Stones" },
                 { filename: "Double Dragon.nes", title: "Double Dragon" },
                 { filename: "Dr. Mario (U) [!p] [T-Rus] by Multisoft.nes", title: "Dr. Mario (Русская версия от Multisoft)" },
                 { filename: "onlain-igrok.rf_23573.nes", title: "Duck Tales" }, // Используем это название
                 { filename: "Duck Tales 2.nes", title: "DuckTales 2" },
                 { filename: "Felix the Cat.nes", title: "Felix the Cat" },
                 { filename: "Final Fantasy 2.nes", title: "Final Fantasy II" },
                 { filename: "Final Fantasy 3.nes", title: "Final Fantasy III" },
                 { filename: "Final Fantasy.nes", title: "Final Fantasy" },
                 { filename: "Final Mission.nes", title: "S.C.A.T.: Special Cybernetic Attack Team" }, // Корректное название
                 { filename: "Jackal.nes", title: "Jackal" },
                 { filename: "Lode Runner (U) [T-Rus] by Multisoft.nes", title: "Lode Runner (Русская версия от Multisoft)" },
                 { filename: "Mario Bros.nes", title: "Mario Bros." },
                 { filename: "Mega Man5.nes", title: "Mega Man 5" },
                 { filename: "Megaman6.nes", title: "Mega Man 6" },
                 { filename: "Mega_Man.nes", title: "Mega Man" },
                 { filename: "Mega_Man2.nes", title: "Mega Man 2" },
                 { filename: "Mega_Man3.nes", title: "Mega Man 3" },
                 { filename: "Mega_Man4.nes", title: "Mega Man 4" },
                 { filename: "Mighty Final Fight.nes", title: "Mighty Final Fight" },
                 { filename: "Monster In My Pocket.nes", title: "Monster in My Pocket" },
                 { filename: "Pac-Man.nes", title: "Pac-Man" },
                 { filename: "prince-of-persia-rus_onlain-igrok.rf_.nes", title: "Prince of Persia (Русская версия)" },
                 { filename: "Robocop-2.nes", title: "RoboCop 2" },
                 { filename: "Robocop-3.nes", title: "RoboCop 3" },
                 { filename: "RoboCop.nes", title: "RoboCop" },
                 { filename: "shadow of the ninja.nes", title: "Shadow of the Ninja" },
                 { filename: "Silkworm.nes", title: "Silkworm" },
                 { filename: "Super Contra.nes", title: "Super C (Super Contra)" }, // Корректное название
                 { filename: "super-mario-bros.-2-rus.nes", title: "Super Mario Bros. 2 (Русская версия)" },
                 { filename: "super-mario-bros.-3-e-t-rus-by-2r-team-2r-team.nes", title: "Super Mario Bros. 3 (Русская версия от 2R Team)" },
                 { filename: "TaleSpin.nes", title: "TaleSpin" },
                 { filename: "teenage-mutant-ninja-turtles-ii-the-arcade-game.nes", title: "Teenage Mutant Ninja Turtles II: The Arcade Game" },
                 { filename: "teenage-mutant-ninja-turtles-rus.nes", title: "Teenage Mutant Ninja Turtles (Русская версия)" },
                 { filename: "teenage-mutant-ninja-turtles-tournament-fighters.nes", title: "Teenage Mutant Ninja Turtles: Tournament Fighters" },
                 { filename: "The Flintstones - The Rescue of Dino & Hoppy.nes", title: "The Flintstones: The Rescue of Dino & Hoppy" },
                 { filename: "The Flintstones 2 - The Surprise at Dinosaur Peak.nes", title: "The Flintstones: Surprise at Dinosaur Peak" }, // Скорректировано
                 { filename: "Tiny Toon Adventures 2.nes", title: "Tiny Toon Adventures 2: Trouble in Wackyland" },
                 { filename: "Tiny_Toon_Adventures-U-.nes", title: "Tiny Toon Adventures" },
                 { filename: "Tokkyuu Shirei - Solbrain.nes", title: "Tokkyuu Shirei Solbrain" },
                 { filename: "tom-jerry-u-p1trus_onlain-igrok.rf_.nes", title: "Tom and Jerry (Русская версия)" }
             ].map(game => ({
                 ...game,
                 id: generateId(game.filename) // Генерируем ID
             }));

            // Обогащаем оба списка игр данными из gameDetailsData
            const enrichGameData = (gameList) => {
                return gameList.map(game => {
                    const details = gameDetailsData[game.title] || {};
                    // Особый случай для Battle City / Tank 1990
                    if (game.id === 'tank_1990') {
                         const detailsBC = gameDetailsData["Battle City"] || {};
                         return { ...game, title: "Battle City", genre: detailsBC.genre || 'Аркада', description: detailsBC.description || 'Легендарная танковая баталия.' };
                    }
                     // Особый случай для S.C.A.T. / Final Mission
                    if (game.id === 'final_mission') {
                        const detailsSCAT = gameDetailsData["S.C.A.T.: Special Cybernetic Attack Team"] || {};
                        return { ...game, title: "S.C.A.T.", genre: detailsSCAT.genre || 'Экшен', description: detailsSCAT.description || 'Летающий экшен-платформер.' };
                    }
                    // Особый случай для Super C / Super Contra
                    if (game.id === 'super_contra') {
                        const detailsSuperC = gameDetailsData["Super C (Super Contra)"] || {};
                        return { ...game, title: "Super C", genre: detailsSuperC.genre || 'Экшен', description: detailsSuperC.description || 'Продолжение знаменитой Contra.' };
                    }
                    return {
                        ...game,
                        genre: details.genre || 'Неизвестно',
                        description: details.description || 'Описание для этой игры пока не добавлено.',
                        romUrl: game.romUrl || `roms/catalog/${game.filename}` // Добавляем romUrl для каталога
                    };
                });
            };

            window.libraryGames = enrichGameData(initialLibraryGames);
            window.fullCatalogGames = enrichGameData(initialFullCatalogGames);


            // --- Популярные и ТОП игры ---
            const popularGameIds = [ 'battletoads_double_dragon', 'teenage_manhattan', 'tiny_toon_adventures_u', 'chip_n_dale_rescue_rangers_rus', 'dr_mario_u_p_t_rus_by_multisoft', 'mega_man', 'pac_man'];
            const topGameIds = [ 'battletoads_double_dragon', 'chip_n_dale_rescue_rangers_rus', 'felix_the_cat', 'mario_bros', 'tank_1990', 'teenage_mutant_ninja_turtles_rus', 'teenage_mutant_ninja_turtles_ii_the_arcade_game', 'tom_jerry_u_p1trus_onlain_igrok_rf', 'robocop'];

            const findGameDataById = (id) => window.libraryGames.find(g => g.id === id) || window.fullCatalogGames.find(g => g.id === id);

            const popularGamesList = popularGameIds.map(findGameDataById).filter(Boolean);
            const topGamesList = topGameIds.map(findGameDataById).filter(Boolean);

            window.orientationShown = false;
            window.currentRomUrl = null;
            window.currentGameName = null;
            window.isEmulatorActive = false;

             const imageMap = {
                // ID из libraryGames
                "mario": "mario.webp",
                "contra": "contra.webp",
                "battle_city": "battlecity.webp",
                "duck_hunt": "duckhunt.webp",
                "tetris": "tetris.webp",
                "ninja_gaiden": "ninja.webp",
                // ID из fullCatalogGames (генерируемые через generateId)
                "teenage_manhattan": "manhattan.webp",
                "tank_1990": "battlecity.webp",
                "adventure_islan": "adventure_island1.webp",
                "adventure_islan2": "adventure_islan2.webp",
                "adventure_islan3": "adventure_islan3.webp",
                "adventure_islan4": "adventure_islan4.webp",
                "alien_3": "Alien_3.webp", // Исправлено имя файла
                "batman_returns": "Batman_Returns.webp",
                "batman": "Batman.webp",
                "battletoads_double_dragon": "BattletoadsDoubleDragon.webp",
                "battletoads_rus": "Battletoadsrus.webp",
                "best_of_the_best_championship_karate": "BBCKarate.webp",
                "blades_of_steel": "BladesofSteel.webp",
                "bomberman_u_t_rus": "Bomberman.webp",
                "bomberman2": "Bomberman2.webp",
                "bucky_o_hare": "BuckyOHare.webp",
                "captain_america_and_the_avengers": "CaptainAmerica.webp",
                "castlevania_2_simon_s_quest": "Castlevania2.webp",
                "castlevania_3_dracula_s_curse": "Castlevania3.webp",
                "castlevania": "Castlevania.webp",
                "chip_n_dale_rescue_rangers_2_u_t_rus_by_shedevr": "Chip2.webp",
                "chip_n_dale_rescue_rangers_rus": "chipr.webp",
                "contra_force": "contra_force.webp",
                "darkwing_duck_u": "darkwing_duck_u.webp",
                "double_dragon_ii_the_revenge": "double_dragon_revenge.webp",
                "double_dragon_iii_the_sacred_stones": "DoubleDragonSacred.webp",
                "double_dragon": "DoubleDragon.webp",
                "dr_mario_u_p_t_rus_by_multisoft": "dr_mario.webp",
                "duck_tales": "dt.webp", // Для onlain-igrok.rf_23573.nes -> duck_tales
                "duck_tales_2": "DuckTales2.webp",
                "felix_the_cat": "felix_the_cat.webp",
                "final_fantasy_2": "final_fantasy_2.webp",
                "final_fantasy_3": "final_fantasy_3.webp",
                "final_fantasy": "final_fantasy.webp",
                "final_mission": "final_mission.webp", // Для S.C.A.T.
                "jackal": "Jackal.webp",
                "lode_runner_u_t_rus_by_multisoft": "lode_runner.webp",
                "mario_bros": "mario_bros.webp",
                "mega_man5": "mega_man5.webp",
                "megaman6": "megaman6.webp",
                "mega_man": "mega_man.webp",
                "mega_man2": "Mega_Man2.webp",
                "mega_man3": "Mega_Man3.webp",
                "mega_man4": "Mega_Man4.webp",
                "mighty_final_fight": "mighty_final_fight.webp",
                "monster_in_my_pocket": "monster_in_my_pocket.webp",
                "pac_man": "pac_man.webp",
                "prince_of_persia_rus": "prince_of_persia.webp",
                "robocop_2": "robocop_2.webp",
                "robocop_3": "robocop_3.webp",
                "robocop": "robocop.webp",
                "shadow_of_the_ninja": "shadow_of_the_ninja.webp",
                "silkworm": "silkworm.webp",
                "super_contra": "super_contra.webp", // Для Super C
                "super_mario_bros_2_rus": "super_mario_bros_2_rus.webp",
                "super_mario_bros_3_e_t_rus_by_2r_team_2r_team": "super_mario_bros_3.webp",
                "talespin": "talespin.webp",
                "teenage_mutant_ninja_turtles_ii_the_arcade_game": "teenagemutantarcade.webp",
                "teenage_mutant_ninja_turtles_rus": "teenagemutant.webp",
                "teenage_mutant_ninja_turtles_tournament_fighters": "teenagemutantfighters.webp",
                "the_flintstones_the_rescue_of_dino_hoppy": "Flintstones.webp",
                "the_flintstones_2_the_surprise_at_dinosaur_peak": "Flintstones2.webp",
                "tiny_toon_adventures_2": "tiny_toon_adventures_2.webp",
                "tiny_toon_adventures_u": "tiny_toon_adventures.webp",
                "tokkyuu_shirei_solbrain": "tokkyuu_shirei_solbrain.webp",
                "tom_jerry_u_p1trus_onlain_igrok_rf": "tom_jerry.webp"
            };

            const imgBasePath = "data/img/games/";
            const catalogImgBasePath = "data/img/catalog/";

            // Функция отрисовки сетки игр (Хиты, Поиск, Недавние, Популярные, ТОП, Избранное)
            function renderGamesGrid(gamesToRender, targetGridElement) {
                targetGridElement.innerHTML = '';
                if (!gamesToRender || gamesToRender.length === 0) {
                    targetGridElement.innerHTML = '<p style="color: #aaa; grid-column: 1 / -1; text-align: center; margin-top: 20px;">Игры не найдены.</p>';
                    return;
                }
                gamesToRender.forEach(game => {
                    if (!game || !game.id || !game.title || !game.romUrl) {
                        console.warn("Пропуск игры (renderGamesGrid) с неполными данными:", game);
                        return;
                    }
                    const gameCard = document.createElement('div');
                    gameCard.className = 'retro-game-card';

                    let imagePath = imageMap[game.id] ? (imgBasePath + imageMap[game.id]) : `${catalogImgBasePath}${game.id}.webp`;
                    // Если картинка в каталоге не найдена, пробуем базовую
                    const fallbackImage = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    const imageErrorHandler = `this.onerror=null; this.src='${catalogImgBasePath}${game.id}.webp'; this.onerror=function(){this.onerror=null; this.src='${fallbackImage}';}`;


                    const isInFavorites = favoritesManager.isInFavorites(game.id);
                    const favoriteButtonClass = isInFavorites ? 'remove-favorite' : 'add-favorite';
                    const favoriteButtonText = isInFavorites ? '★' : '☆';

                    gameCard.innerHTML = `
                        <div class="favorite-button ${favoriteButtonClass}" data-game-id="${game.id}">${favoriteButtonText}</div>
                        <img src="${imagePath}" alt="${game.title}" class="retro-game-image" onerror="${imageErrorHandler}">
                        <div class="retro-game-title">${game.title}</div>
                    `;

                    // Клик по карточке открывает страницу игры
                    gameCard.addEventListener('click', (e) => {
                        if (e.target.classList.contains('favorite-button') || e.target.closest('.favorite-button')) {
                            return; // Игнорируем клик по кнопке избранного
                        }
                        // Используем замыкание, чтобы передать правильный объект game
                        const clickedGame = gamesToRender.find(g => g.id === game.id);
                        if (clickedGame) {
                           showGamePage(clickedGame);
                        } else {
                           console.error("Не удалось найти данные для игры:", game.id);
                        }
                    });

                    // Обработчик для кнопки избранного
                    const favoriteButton = gameCard.querySelector('.favorite-button');
                    if (favoriteButton) {
                        favoriteButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // Предотвращаем открытие страницы игры
                            const gameId = e.target.dataset.gameId;
                             // Получаем полные данные игры для добавления в избранное
                            const gameToAdd = findGameDataById(gameId);
                            if (!gameToAdd) return;

                            if (favoritesManager.isInFavorites(gameId)) {
                                if (favoritesManager.removeFromFavorites(gameId)) {
                                    e.target.classList.remove('remove-favorite');
                                    e.target.classList.add('add-favorite');
                                    e.target.textContent = '☆';
                                }
                            } else {
                                if (favoritesManager.addToFavorites(gameToAdd)) { // Передаем полный объект
                                    e.target.classList.remove('add-favorite');
                                    e.target.classList.add('remove-favorite');
                                    e.target.textContent = '★';
                                }
                            }
                             // Обновляем вид кнопки избранного на странице игры, если она открыта для этой игры
                            const gamePageFavButton = document.querySelector(`#game-page-favorite-btn[data-game-id="${gameId}"]`);
                            if(gamePageFavButton) {
                                const isNowFavorite = favoritesManager.isInFavorites(gameId);
                                gamePageFavButton.className = `favorite-button ${isNowFavorite ? 'remove-favorite' : 'add-favorite'}`;
                                gamePageFavButton.textContent = isNowFavorite ? '★' : '☆';
                            }
                        });
                    }

                    targetGridElement.appendChild(gameCard);
                });
            }

            // Функция для отрисовки каталога (может использовать renderGamesGrid)
             function renderCatalogGrid(catalogData, targetGridElement) {
                 // В catalogData у нас объекты с filename, title, id, genre, description
                 // Нужно добавить romUrl перед передачей в renderGamesGrid
                 const gamesWithRomUrl = catalogData.map(g => ({
                     ...g,
                     romUrl: g.romUrl || `roms/catalog/${g.filename}`
                 }));
                 renderGamesGrid(gamesWithRomUrl, targetGridElement);
             }


            // Функция отображения страницы игры
            function showGamePage(game) {
                const gamePageArea = document.getElementById('game-page-area');
                if (!game || !game.id || !gamePageArea) {
                    console.error("Не удалось отобразить страницу игры:", game);
                    return;
                }

                // Находим полные данные игры (на всякий случай, если передан неполный объект)
                let fullGameData = findGameDataById(game.id);
                if (!fullGameData) {
                    fullGameData = game; // Используем переданные данные, если не нашли в глобальных списках
                }

                // Убедимся, что romUrl есть
                const romPath = fullGameData.romUrl || `roms/catalog/${fullGameData.filename}`;
                 if (!romPath) {
                     console.error("Не удалось определить ROM path для игры:", fullGameData.title);
                     alert("Ошибка: не удалось найти файл игры.");
                     return;
                 }

                let imagePath = imageMap[fullGameData.id] ? (imgBasePath + imageMap[fullGameData.id]) : `${catalogImgBasePath}${fullGameData.id}.webp`;
                const fallbackImage = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                const imageErrorHandler = `this.onerror=null; this.src='${catalogImgBasePath}${fullGameData.id}.webp'; this.onerror=function(){this.onerror=null; this.src='${fallbackImage}';}`;


                const isInFavorites = favoritesManager.isInFavorites(fullGameData.id);
                const favoriteButtonClass = isInFavorites ? 'remove-favorite' : 'add-favorite';
                const favoriteButtonText = isInFavorites ? '★' : '☆';

                gamePageArea.innerHTML = `
                    <div class="game-page-container">
                        <div class="game-page-header">
                            <button class="game-page-back-button" id="game-page-back-btn" title="Назад">&#10094;</button>
                            <span class="game-page-genre">${fullGameData.genre || 'Неизвестно'}</span>
                        </div>

                        <div class="game-page-title-container">
                             <h2 class="game-page-title">${fullGameData.title}</h2>
                             <div class="favorite-button ${favoriteButtonClass}" id="game-page-favorite-btn" data-game-id="${fullGameData.id}" title="${isInFavorites ? 'Удалить из избранного' : 'Добавить в избранное'}">${favoriteButtonText}</div>
                        </div>

                        <img src="${imagePath}" alt="${fullGameData.title}" class="game-page-logo" onerror="${imageErrorHandler}">

                        <div class="game-page-screenshots">
                            <p>(Здесь будут скриншоты)</p>
                        </div>

                        <div class="game-page-description">
                            ${fullGameData.description || 'Описание не найдено.'}
                        </div>

                        <button class="game-page-play-button" id="game-page-play-btn">ИГРАТЬ</button>
                    </div>
                `;

                // Обработчики для кнопок на странице игры
                const playButton = gamePageArea.querySelector('#game-page-play-btn');
                const backCatalogButton = gamePageArea.querySelector('#game-page-back-btn');
                const favoriteButton = gamePageArea.querySelector('#game-page-favorite-btn');

                if (playButton) {
                    playButton.onclick = () => {
                        gamePageArea.classList.add('hidden'); // Скрываем страницу игры
                        loadGameFromUrl(romPath, fullGameData.title); // Запускаем игру
                    };
                }

                if (backCatalogButton) {
                    backCatalogButton.onclick = () => {
                        gamePageArea.classList.add('hidden');
                        // Возвращаемся к предыдущему виду (главная или результаты поиска/каталог)
                        if (!mainContent.classList.contains('hidden')) {
                             // Уже на главной, ничего не делаем (теоретически сюда не должны попасть)
                        } else if (!searchResultsArea.classList.contains('hidden')) {
                             searchResultsArea.classList.remove('hidden'); // Возврат к списку
                        } else if (alphaListOverlay && !alphaListOverlay.classList.contains('hidden')){
                             alphaListOverlay.classList.remove('hidden'); // Возврат к алфавитному списку
                             document.body.style.overflow = 'hidden'; // Блокируем скролл для оверлея
                        }
                         else {
                            showMainContent(); // По умолчанию на главную
                        }
                        window.scrollTo(0, 0); // Прокрутка вверх
                    };
                }

                 // Обработчик для кнопки избранного на странице игры
                 if (favoriteButton) {
                    favoriteButton.onclick = () => {
                        const gameId = favoriteButton.dataset.gameId;
                        if (favoritesManager.isInFavorites(gameId)) {
                            if (favoritesManager.removeFromFavorites(gameId)) {
                                favoriteButton.classList.remove('remove-favorite');
                                favoriteButton.classList.add('add-favorite');
                                favoriteButton.textContent = '☆';
                                favoriteButton.title = 'Добавить в избранное';
                            }
                        } else {
                             // Передаем полные данные, т.к. они у нас есть (fullGameData)
                            if (favoritesManager.addToFavorites(fullGameData)) {
                                favoriteButton.classList.remove('add-favorite');
                                favoriteButton.classList.add('remove-favorite');
                                favoriteButton.textContent = '★';
                                favoriteButton.title = 'Удалить из избранного';
                            }
                        }
                         // Обновляем звездочки в списках игр, если они видимы
                         document.querySelectorAll(`.favorite-button[data-game-id="${gameId}"]`).forEach(btn => {
                             if (btn !== favoriteButton) { // Не обновляем саму себя
                                 const isNowFavorite = favoritesManager.isInFavorites(gameId);
                                 btn.className = `favorite-button ${isNowFavorite ? 'remove-favorite' : 'add-favorite'}`;
                                 btn.textContent = isNowFavorite ? '★' : '☆';
                             }
                         });
                         // Обновляем звездочку в алфавитном списке
                         const alphaListItem = document.querySelector(`.alpha-list-item[data-game-id="${gameId}"] .favorite-indicator`);
                         if(alphaListItem) {
                            alphaListItem.style.display = favoritesManager.isInFavorites(gameId) ? 'inline-block' : 'none';
                         }
                    };
                 }

                 // Показываем страницу игры, скрываем остальное
                 mainContent.classList.add('hidden');
                 searchResultsArea.classList.add('hidden');
                 display.classList.add('hidden');
                 if (alphaListOverlay) alphaListOverlay.classList.add('hidden');

                 document.body.style.overflow = ''; // Разрешаем скролл для страницы игры
                 gamePageArea.classList.remove('hidden');
                 window.scrollTo(0, 0); // Прокрутка вверх

                 // Отправляем событие просмотра игры для системы достижений
                 const gameViewedEvent = new CustomEvent('gameViewed', {
                    detail: { gameId: fullGameData.id, gameTitle: fullGameData.title }
                 });
                 document.dispatchEvent(gameViewedEvent);
                 console.log("AchievementSystem: gameViewed event dispatched for", fullGameData.id); // Отладка
            }


             // Функция показа главной страницы
             function showMainContent() {
                 searchResultsArea.classList.add('hidden');
                 document.getElementById('game-page-area').classList.add('hidden');
                 if (alphaListOverlay) alphaListOverlay.classList.add('hidden');

                 document.body.style.overflow = ''; // Возвращаем скролл
                 display.classList.add('hidden'); // Скрываем эмулятор
                 backButton.style.display = 'none'; // Скрываем кнопку Назад эмулятора
                 reloadEmulatorButton.style.display = 'none'; // Скрываем кнопку Перезагрузки эмулятора

                 mainContent.classList.remove('hidden');
                 searchInput.value = ''; // Очищаем поиск
                 renderGamesGrid(window.libraryGames, initialRetroGamesGrid); // Перерисовываем хиты (обновляем звезды)
             }

            // Функция выполнения поиска (ищет везде: хиты + каталог)
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (!searchTerm) return;

                const allGames = [...window.libraryGames, ...window.fullCatalogGames];
                // Убираем дубликаты по ID
                const uniqueGames = allGames.reduce((acc, current) => {
                     if (!acc.find(item => item.id === current.id)) {
                         acc.push(current);
                     }
                     return acc;
                 }, []);

                const filteredGames = uniqueGames.filter(game =>
                    game.title.toLowerCase().includes(searchTerm)
                );

                searchResultsArea.innerHTML = ''; // Очищаем предыдущие результаты
                const titleElement = document.createElement('h2');
                titleElement.className = 'search-results-title';
                titleElement.textContent = `Результаты поиска: "${searchInput.value}"`;
                searchResultsArea.appendChild(titleElement);

                const backToMainButton = document.createElement('button');
                backToMainButton.className = 'back-to-main-button';
                backToMainButton.textContent = '‹ Назад';
                backToMainButton.onclick = showMainContent;
                searchResultsArea.appendChild(backToMainButton);

                const resultsGrid = document.createElement('div');
                resultsGrid.className = 'retro-games-grid';
                searchResultsArea.appendChild(resultsGrid);

                renderGamesGrid(filteredGames, resultsGrid); // Отображаем результаты

                mainContent.classList.add('hidden'); // Скрываем основной контент
                searchResultsArea.classList.remove('hidden'); // Показываем результаты
                window.scrollTo(0, 0); // Прокрутка вверх
            }

            // Функция отображения секции (Недавние, Популярные, ТОП, Каталог)
            function showGameListSection(gamesList, sectionTitle) {
                 searchResultsArea.innerHTML = ''; // Очищаем
                 const titleElement = document.createElement('h2');
                 titleElement.className = 'search-results-title';
                 titleElement.textContent = sectionTitle;
                 searchResultsArea.appendChild(titleElement);

                 const backToMainButton = document.createElement('button');
                 backToMainButton.className = 'back-to-main-button';
                 backToMainButton.textContent = '‹ Назад';
                 backToMainButton.onclick = showMainContent;
                 searchResultsArea.appendChild(backToMainButton);

                 const resultsGrid = document.createElement('div');
                 resultsGrid.className = 'retro-games-grid';
                 searchResultsArea.appendChild(resultsGrid);

                 // Если это каталог, используем renderCatalogGrid, иначе renderGamesGrid
                 if (sectionTitle.toLowerCase().includes("каталог")) {
                    renderCatalogGrid(gamesList, resultsGrid);
                 } else {
                    renderGamesGrid(gamesList, resultsGrid);
                 }


                 mainContent.classList.add('hidden'); // Скрываем основной контент
                 searchResultsArea.classList.remove('hidden'); // Показываем секцию
                 window.scrollTo(0, 0); // Прокрутка вверх
            }

            // Функция отображения недавних игр
            function showRecentGames() {
                 try {
                     const recentGames = JSON.parse(localStorage.getItem('recentGamesList') || '[]');
                     showGameListSection(recentGames, 'Недавние игры');
                 } catch (e) {
                     console.error("Ошибка отображения недавних игр:", e);
                     alert("Не удалось загрузить список недавних игр.");
                 }
            }

             // Функция отображения каталога
             function showCatalog(catalogData, catalogTitle) {
                 showGameListSection(catalogData, catalogTitle);
             }

             // Функция отображения популярных игр
             function showPopularGames() {
                 showGameListSection(popularGamesList, 'Популярные игры');
             }

             // Функция отображения ТОП игр
             function showTopGames() {
                 showGameListSection(topGamesList, 'ТОП ИГР');
             }

             // Функция отображения избранных игр
             function showFavorites() {
                 const favorites = favoritesManager.getFavorites();
                 showGameListSection(favorites, 'Избранные игры');
             }

            // Загрузка игры по URL
            function loadGameFromUrl(romUrl, gameName) {
                loadGame(romUrl, gameName, defaultCore);
            }

             // Исходная функция загрузки игры (для переопределения)
             function originalLoadGameFromUrl(romUrl, gameName) {
                 loadGame(romUrl, gameName, defaultCore);
             }


            // Обработка DND, выбора файла
            uploadBox.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.setAttribute("drag", true);
            });
            uploadBox.addEventListener('dragleave', function() {
                this.removeAttribute("drag");
            });
            uploadBox.addEventListener('drop', function(e) {
                e.preventDefault();
                this.removeAttribute("drag");
                if (e.dataTransfer.files.length > 0) {
                    handleRomFile(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleRomFile(this.files[0]);
                }
            });

            function handleRomFile(file) {
                const fileName = file.name;
                const parts = fileName.split(".");
                const extension = parts.length > 1 ? parts.pop().toLowerCase() : '';
                const gameName = parts.join(".");
                if (["fds", "nes", "unif", "unf"].includes(extension)) {
                    loadGame(file, gameName, defaultCore); // Передаем объект File
                } else {
                    alert("Этот формат файла не поддерживается...");
                }
            }

            // --- ОСНОВНАЯ ФУНКЦИЯ ЗАГРУЗКИ ИГРЫ (ИЗМЕНЕННАЯ) ---
            function loadGame(romFile, gameName, core) {
                stopEmulator(); // Остановка предыдущего эмулятора, если был

                // --- Определение ID игры ---
                let gameId = null;
                let gameDataToStore = null;

                if (typeof romFile === 'string') { // Если передан URL
                    // Сначала ищем в libraryGames (Хиты)
                    gameDataToStore = window.libraryGames.find(g => g.romUrl === romFile);
                    // Если не нашли, ищем в fullCatalogGames (Каталог) по romUrl или по имени файла
                    if (!gameDataToStore) {
                         gameDataToStore = window.fullCatalogGames.find(g => g.romUrl === romFile || `roms/catalog/${g.filename}` === romFile);
                    }
                    // Особый случай для файлов из каталога, если romUrl не совпал напрямую
                    if (!gameDataToStore && romFile.startsWith('roms/catalog/')) {
                        const filename = romFile.split('/').pop();
                        gameDataToStore = window.fullCatalogGames.find(g => g.filename === filename);
                    }
                    if (gameDataToStore) gameId = gameDataToStore.id;

                } else if (romFile instanceof File) { // Если передан объект File
                    // Для загруженных файлов попробуем найти по имени (менее надежно)
                    gameDataToStore = window.libraryGames.find(g => g.title === gameName) ||
                                     window.fullCatalogGames.find(g => g.title === gameName);
                    if (gameDataToStore) {
                         gameId = gameDataToStore.id;
                    } else {
                         console.log("Загруженная игра не найдена в списках, ID не определен для достижений.");
                         gameId = null; // Оставляем null для загруженных ROM, если не нашли
                    }
                }
                console.log(`Attempting to load game: Name='${gameName}', ID='${gameId}'`); // Отладка

                // Сохраняем найденный ID для использования в EJS_onGameStart
                window.currentlyLoadingGameId = gameId; // Используем глобальную переменную временно
                // --- Конец определения ID ---


                // Сохранение в недавние (ваш код)
                if (gameDataToStore && gameDataToStore.id) { // Используем найденные данные
                    try {
                        const MAX_RECENT_GAMES = 9;
                        let recentGames = JSON.parse(localStorage.getItem('recentGamesList') || '[]');
                        recentGames = recentGames.filter(g => g.id !== gameDataToStore.id); // Удаляем дубликат

                        let recentRomUrl = '';
                        if (typeof romFile === 'string') {
                            recentRomUrl = romFile;
                        } else { // Если загружен файл, используем URL из найденных данных
                            recentRomUrl = gameDataToStore.romUrl;
                        }

                         if (recentRomUrl) { // Добавляем только если есть URL
                             recentGames.unshift({
                                 id: gameDataToStore.id,
                                 title: gameDataToStore.title, // Берем title из найденных данных
                                 romUrl: recentRomUrl,
                                 genre: gameDataToStore.genre // Добавляем жанр
                             });
                             recentGames = recentGames.slice(0, MAX_RECENT_GAMES);
                             localStorage.setItem('recentGamesList', JSON.stringify(recentGames));
                         }
                    } catch (e) {
                        console.error("Ошибка сохранения недавних игр:", e);
                    }
                } else if (gameId === null && typeof romFile === 'object') {
                     console.log("Игра загружена как файл и не найдена в каталоге, не добавляем в недавние.");
                }


                // --- Подготовка к запуску эмулятора ---
                window.currentRomUrl = romFile; // Может быть URL или File
                window.currentGameName = gameName;
                window.orientationShown = false;
                window.isEmulatorActive = true;

                // Скрываем все остальные интерфейсы
                mainContent.classList.add('hidden');
                searchResultsArea.classList.add('hidden');
                document.getElementById('game-page-area').classList.add('hidden');
                if (alphaListOverlay) alphaListOverlay.classList.add('hidden');
                document.body.style.overflow = 'hidden'; // Запрещаем прокрутку

                // Показываем эмулятор и кнопки управления им
                display.classList.remove('hidden');
                backButton.style.display = 'flex';
                reloadEmulatorButton.style.display = 'flex';

                if (isMobile) {
                    enableFullscreen();
                }

                // --- Настройка параметров EJS ---
                window.EJS_player = "#game";
                window.EJS_gameName = gameName;
                window.EJS_biosUrl = "";
                window.EJS_gameUrl = romFile; // Передаем URL или File
                window.EJS_core = 'nes';
                window.EJS_pathtodata = "data/";
                window.EJS_startOnLoaded = true;
                window.EJS_DEBUG_XX = enableDebug;
                window.EJS_disableDatabases = true; // Отключаем сохранение в IndexedDB эмулятора (если не нужно)
                window.EJS_threads = enableThreads;
                window.EJS_language = "ru-RU";

                 // Отключение кнопок сохранения/загрузки и других ненужных
                 window.EJS_Buttons = {
                    playPause: true,    // Оставляем Play/Pause
                    restart: true,     // Оставляем Restart
                    mute: false,       // Убираем Mute (есть Volume)
                    settings: false,   // Убираем Settings
                    fullscreen: true,  // Оставляем Fullscreen
                    saveState: false,  // Убираем Save State
                    loadState: false,  // Убираем Load State
                    screenRecord: false,// Убираем Screen Record
                    gamepad: false,    // Убираем Gamepad Mapping (если не нужно)
                    cheat: false,      // Убираем Cheats
                    volume: true,      // Оставляем Volume Slider
                    saveSavFiles: false, // Убираем Export Battery Save
                    loadSavFiles: false, // Убираем Import Battery Save
                    quickSave: false,  // Убираем Quick Save
                    quickLoad: false,  // Убираем Quick Load
                    screenshot: false, // Убираем Screenshot
                    cacheManager: false,// Убираем Cache Manager
                    exitEmulation: false,// Убираем Exit (есть наша кнопка backButton)
                    fastForward: false,// Убираем Fast Forward
                    rewind: false      // Убираем Rewind
                 };


                // --- Назначаем колбэк EJS_onGameStart ---
                window.EJS_onGameStart = function() {
                    const startedGameId = window.currentlyLoadingGameId; // Получаем ID запущенной игры
                    console.log('EJS_onGameStart triggered. Game ID:', startedGameId); // Для отладки

                    // Вызываем метод системы достижений с сохраненным ID
                    if (window.achievementSystem) {
                         window.achievementSystem.onGameStarted(startedGameId); // Передаем ID (может быть null)
                    }

                    // Ваш остальной код для onGameStart
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                    setTimeout(fixCanvasScaling, 1000); // Попробуем исправить масштабирование

                    // Удаляем кнопки Fast/Slow, если они все же появились
                    document.querySelectorAll('.ejs_menu_button, .ejs_context_menu li').forEach(el => {
                       const text = el.innerText.trim().toLowerCase();
                       if (text === 'fast' || text === 'slow') {
                         el.remove();
                       }
                    });

                    // Очищаем временную переменную после использования
                    window.currentlyLoadingGameId = null;
                };
                // --- Конец назначения колбэка ---

                // --- Загружаем скрипт эмулятора ---
                const script = document.createElement("script");
                script.id = "emulatorScript";
                script.src = "data/loader.js";
                // Удаляем старый скрипт перед добавлением нового
                const oldScript = document.getElementById('emulatorScript');
                if (oldScript) {
                    oldScript.remove();
                }
                document.body.appendChild(script);
                // --- Конец загрузки скрипта ---

            } // --- Конец функции loadGame ---



            // Функции управления эмулятором, ориентацией, аудио и т.д.
            backButton.addEventListener('click', function() {
                 stopEmulator();
                 display.classList.add('hidden');
                 backButton.style.display = 'none';
                 reloadEmulatorButton.style.display = 'none';
                 window.currentRomUrl = null;
                 window.currentGameName = null;
                 window.orientationShown = false;
                 window.isEmulatorActive = false;

                 // Определяем, куда вернуться
                 if (!searchResultsArea.classList.contains('hidden')) {
                     // Если были в результатах поиска/каталоге/недавних и т.д.
                     searchResultsArea.classList.remove('hidden'); // Показываем их снова
                 } else if (alphaListOverlay && !alphaListOverlay.classList.contains('hidden')) {
                      // Если были в алфавитном списке
                      alphaListOverlay.classList.remove('hidden'); // Показываем его снова
                      document.body.style.overflow = 'hidden'; // Блокируем скролл для оверлея
                 }
                 else {
                      mainContent.classList.remove('hidden'); // По умолчанию на главную
                 }
                  document.body.style.overflow = ''; // Разрешаем скролл (кроме случая с оверлеем)
                  if (alphaListOverlay && !alphaListOverlay.classList.contains('hidden')) {
                      document.body.style.overflow = 'hidden';
                  }

                 document.body.classList.remove('fullscreen-mode'); // Выход из полноэкранного режима
                 console.log("Fullscreen mode disabled by back button.");
                 window.scrollTo(0, 0); // Прокрутка вверх
            });


            reloadEmulatorButton.addEventListener('click', function() {
                loadingState.style.display = 'flex';
                setTimeout(() => {
                    reloadEmulator(); // Перезагрузка логики эмулятора
                    setTimeout(() => {
                         loadingState.style.display = 'none';
                    }, 1500); // Даем время на перезагрузку
                }, 500);
            });

            // Проверка ориентации (упрощенная)
             function checkOrientation() {
                 if (!window.isEmulatorActive || window.orientationShown || !isMobile) {
                     orientationMessage.style.display = 'none';
                     return;
                 }
                 const isLandscape = window.innerWidth > window.innerHeight;
                 orientationMessage.style.display = isLandscape ? 'none' : 'flex';
             }

            // Фикс масштабирования Canvas (попытка)
            function fixCanvasScaling() {
                const canvas = document.querySelector('#game canvas');
                if (canvas) {
                    canvas.style.imageRendering = 'pixelated'; // Четкие пиксели
                    canvas.style.width = ''; // Сброс стилей, чтобы эмулятор сам рассчитал
                    canvas.style.height = '';
                    // Иногда помогает переприменить стили родителя
                    const gameDiv = document.getElementById('game');
                    if(gameDiv) {
                        gameDiv.style.display = 'none';
                        void gameDiv.offsetWidth; // Трюк для рефлоу
                        gameDiv.style.display = '';
                    }
                    console.log("Attempted to fix canvas scaling.");
                 } else {
                     console.log("Canvas not found for scaling fix.");
                 }
            }

            // Включение полноэкранного режима (визуального)
             function enableFullscreen() {
                 // Используем класс на body для управления стилями
                 document.body.classList.add('fullscreen-mode');
                 console.log("Fullscreen mode enabled.");
                 // Принудительно проверяем ориентацию при входе в полноэкранный режим
                 //checkOrientation();
                 setTimeout(checkOrientation, 100); // С небольшой задержкой
                 setTimeout(fixCanvasScaling, 200); // И пробуем фикс масштаба
             }

            // Перезагрузка эмулятора
            function reloadEmulator() {
                if (window.currentRomUrl && window.currentGameName) {
                    console.log("Reloading emulator for:", window.currentGameName);
                    // Просто вызываем loadGame снова с текущими параметрами
                    loadGame(window.currentRomUrl, window.currentGameName, defaultCore);
                } else {
                    console.log("Cannot reload emulator: current game data missing.");
                     loadingState.style.display = 'none'; // Скрыть индикатор загрузки, если нечего перезагружать
                }
            }

            // Остановка эмулятора
            function stopEmulator() {
                const gameDiv = document.getElementById("game");
                const emulatorScript = document.getElementById("emulatorScript");
                if (typeof EJS_terminate === 'function') {
                    try {
                        EJS_terminate(); // Пытаемся остановить эмулятор штатно
                        console.log("EJS_terminate called.");
                    } catch (e) {
                        console.error("Error calling EJS_terminate:", e);
                    }
                 } else {
                     console.log("EJS_terminate function not found.");
                 }
                 // Дополнительно очищаем контейнер и удаляем скрипт
                 if (gameDiv) gameDiv.innerHTML = "";
                 if (emulatorScript) emulatorScript.remove();
                 window.isEmulatorActive = false; // Сбрасываем флаг активности
                 console.log("Emulator stopped.");
                 stopAllAudio(); // Останавливаем звуки на всякий случай
            }

            // Остановка аудио (на всякий случай)
            function stopAllAudio() {
                 // Пытаемся получить доступ к AudioContext, если он был создан эмулятором
                 if (window.EJS_emulator && window.EJS_emulator.audioContext && typeof window.EJS_emulator.audioContext.close === 'function') {
                     window.EJS_emulator.audioContext.close().catch(e => console.warn("Could not close emulator AudioContext:", e));
                     console.log("Emulator AudioContext closed.");
                 }
                 // Дополнительно проходимся по всем аудио/видео элементам на странице
                 document.querySelectorAll('audio, video').forEach(el => {
                     if (!el.paused) el.pause();
                 });
                 console.log("Stopped all media elements.");
            }


            // Инициализация Telegram Web App
            function initTelegramWebApp() {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready(); // Сообщаем Telegram, что приложение готово
                    console.log("Telegram Web App SDK initialized.");
                     // Запрос на расширение окна (если нужно)
                     // tg.expand();

                    // Обработка кнопки Назад в интерфейсе Telegram (если включена)
                    // tg.BackButton.onClick(() => {
                    //     if (window.isEmulatorActive) {
                    //         backButton.click(); // Имитируем нажатие нашей кнопки Назад
                    //     } else if (!mainContent.classList.contains('hidden')) {
                    //         // Если на главной, можно закрыть Web App
                    //         tg.close();
                    //     } else {
                    //         // Если в каком-то списке, возвращаемся на главную
                    //         showMainContent();
                    //     }
                    // });
                    // Показываем кнопку Назад Telegram, если мы не на главной
                    // if (!mainContent.classList.contains('hidden') || window.isEmulatorActive) {
                    //     tg.BackButton.show();
                    // } else {
                    //     tg.BackButton.hide();
                    // }
                } else {
                    console.log("Telegram Web App SDK not found.");
                }
            }


            // Обработчики событий окна
            window.addEventListener('orientationchange', () => setTimeout(checkOrientation, 300));
            window.addEventListener('resize', () => {
                checkOrientation();
                if (window.isEmulatorActive) {
                    setTimeout(fixCanvasScaling, 100);
                }
            });

            // Обработчики кнопок интерфейса
            startPlayButton.addEventListener('click', (event) => {
                event.stopPropagation();
                window.orientationShown = true;
                orientationMessage.style.display = 'none';
            });
            orientationMessage.addEventListener('click', function() {
                window.orientationShown = true;
                this.style.display = 'none';
            });

            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    performSearch();
                }
            });

             if (recentGamesButton) recentGamesButton.addEventListener('click', showRecentGames);
             if (homeNavButton) homeNavButton.addEventListener('click', showMainContent);
             if (catalogButton) catalogButton.addEventListener('click', () => showCatalog(window.fullCatalogGames, "Каталог игр"));
             if (catalogNavButton) catalogNavButton.addEventListener('click', () => showCatalog(window.fullCatalogGames, "Каталог игр"));
             if (popularButton) popularButton.addEventListener('click', showPopularGames);
             if (topGamesButton) topGamesButton.addEventListener('click', showTopGames);
             if (favoritesNavButton) favoritesNavButton.addEventListener('click', showFavorites);


            if (shareButton) {
                shareButton.addEventListener('click', () => {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
                         // !!! ЗАМЕНИТЕ 'YourBotUsername' на реальное имя вашего бота !!!
                        const botUrl = "https://t.me/YourBotUsername_bot"; // Пример
                        const shareText = encodeURIComponent("Зацени крутой эмулятор Денди прямо в Телеграм!");
                        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(botUrl)}&text=${shareText}`;
                        window.Telegram.WebApp.openLink(shareUrl);
                    } else {
                        alert("Функция 'Поделиться' работает только внутри Telegram.");
                    }
                });
            }

            // Обработчик для случайной игры
            if (randomButton) {
                randomButton.addEventListener('click', () => {
                    if (window.fullCatalogGames && window.fullCatalogGames.length > 0) {
                        const randomIndex = Math.floor(Math.random() * window.fullCatalogGames.length);
                        const randomGame = window.fullCatalogGames[randomIndex];
                         // Убедимся, что у случайной игры есть romUrl
                         const romPath = randomGame.romUrl || `roms/catalog/${randomGame.filename}`;
                         if (romPath) {
                             loadGameFromUrl(romPath, randomGame.title); // Запускаем игру
                         } else {
                             console.error("Не удалось определить romUrl для случайной игры:", randomGame);
                             alert("Ошибка при выборе случайной игры.");
                         }
                    } else {
                        alert("Каталог игр пуст!");
                    }
                });
            }


            // --- Алфавитный список (Новое) ---
            if (alphaSortButton && alphaListOverlay && alphaListContent && alphaListCloseBtn && window.fullCatalogGames) {
                // Обработчик клика по кнопке "ПО АЛФАВИТУ"
                 alphaSortButton.addEventListener('click', () => {
                     // 1. Сортировка полного каталога игр по названию
                     const sortedCatalog = [...window.fullCatalogGames].sort((a, b) =>
                         a.title.localeCompare(b.title, 'ru', { sensitivity: 'base' })
                     );

                     // 2. Очистка содержимого списка
                     alphaListContent.innerHTML = '';

                     // 3. Генерация списка
                     sortedCatalog.forEach(game => {
                         if (!game || !game.id || !game.title) {
                              console.warn("Пропуск игры (алфавитный список) с неполными данными:", game);
                              return;
                         }
                         const listItem = document.createElement('button');
                         listItem.className = 'alpha-list-item';
                         listItem.dataset.gameId = game.id;

                         const isInFavorites = favoritesManager.isInFavorites(game.id);
                         // Добавляем звезду только если в избранном
                         listItem.innerHTML = `
                              ${isInFavorites ? '<span class="favorite-indicator">★</span>' : ''}
                              ${game.title}
                         `;
                         // Находим звездочку после добавления HTML
                         const starIndicator = listItem.querySelector('.favorite-indicator');
                         if (starIndicator && !isInFavorites) {
                             starIndicator.style.display = 'none'; // Скрываем, если не в избранном
                         }


                         listItem.addEventListener('click', () => {
                              const selectedGame = window.fullCatalogGames.find(g => g.id === listItem.dataset.gameId);
                              if (selectedGame) {
                                   showGamePage(selectedGame); // Открываем страницу игры
                                   alphaListOverlay.classList.add('hidden'); // Скрываем оверлей
                                   document.body.style.overflow = ''; // Восстанавливаем прокрутку
                              } else {
                                   console.error("Не удалось найти данные для игры с ID:", listItem.dataset.gameId);
                                   alert("Ошибка: Не удалось загрузить детали игры.");
                              }
                         });
                         alphaListContent.appendChild(listItem);
                     });

                     // 4. Показ оверлея
                     alphaListOverlay.classList.remove('hidden');
                     document.body.style.overflow = 'hidden'; // Блокируем скролл

                     // 5. Скрываем другие основные области
                     mainContent.classList.add('hidden');
                     searchResultsArea.classList.add('hidden');
                     display.classList.add('hidden');
                     document.getElementById('game-page-area').classList.add('hidden');
                 });


                // Обработчик клика по кнопке "Закрыть" (крестик)
                alphaListCloseBtn.addEventListener('click', () => {
                    alphaListOverlay.classList.add('hidden');
                    document.body.style.overflow = '';
                    showMainContent(); // Возвращаемся на главный экран
                });

                // Закрытие по клику на фон (опционально)
                 alphaListOverlay.addEventListener('click', (event) => {
                     if (event.target === alphaListOverlay) {
                         alphaListOverlay.classList.add('hidden');
                         document.body.style.overflow = '';
                         showMainContent();
                     }
                 });

            } else {
                console.error("Не удалось инициализировать алфавитный список: элементы не найдены или каталог пуст.");
                if (alphaSortButton) {
                     alphaSortButton.disabled = true;
                     alphaSortButton.style.opacity = '0.5';
                     alphaSortButton.style.cursor = 'not-allowed';
                }
            }
            // --- Конец Алфавитного списка ---


            // Инициализация при загрузке
            renderGamesGrid(window.libraryGames, initialRetroGamesGrid); // Отрисовка "8-BIT ХИТЫ"
            initTelegramWebApp(); // Инициализация SDK Телеграм

            // Обработчики для featured-card (кроме каталога)
            document.querySelectorAll('.featured-card:not(#catalog-btn)').forEach(card => {
                card.addEventListener('click', function() {
                    const title = this.querySelector('.featured-title').textContent;
                    if (title === "ПРОДОЛЖИТЬ ИГРУ") {
                        // Логика продолжения последней игры (если есть)
                         try {
                            const recentGames = JSON.parse(localStorage.getItem('recentGamesList') || '[]');
                            if (recentGames.length > 0) {
                                const lastGame = recentGames[0];
                                console.log("Продолжаем игру:", lastGame.title);
                                loadGameFromUrl(lastGame.romUrl, lastGame.title);
                            } else {
                                alert("Нет недавних игр для продолжения.");
                            }
                        } catch (e) {
                            console.error("Ошибка загрузки недавних игр для продолжения:", e);
                            alert("Не удалось загрузить последнюю игру.");
                        }
                    }
                     // Можно добавить обработчики для других featured cards здесь
                });
            });

             // Наблюдатель за DOM для фикса канваса (опционально, если есть проблемы)
             const observer = new MutationObserver((mutations) => {
                 mutations.forEach((mutation) => {
                     if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                         for (let i = 0; i < mutation.addedNodes.length; i++) {
                             const node = mutation.addedNodes[i];
                             // Ищем canvas напрямую или внутри добавленных элементов
                             if (node.nodeName === 'CANVAS' || (node.querySelector && node.querySelector('canvas'))) {
                                 console.log("Canvas added to DOM, attempting resize fix.");
                                 setTimeout(fixCanvasScaling, 50); // Небольшая задержка
                                 // Можно отключить наблюдатель после первого срабатывания, если нужно
                                 // observer.disconnect();
                                 break;
                             }
                         }
                     }
                 });
             });
             // Начинаем наблюдение за контейнером игры
             observer.observe(document.getElementById('game'), { childList: true, subtree: true });

             // --- ИНИЦИАЛИЗАЦИЯ СИСТЕМЫ ДОСТИЖЕНИЙ ---
             // Объект создается ниже, в отдельном блоке кода

        }); // --- Конец DOMContentLoaded ---
    </script>

<style>
/* Контейнер для достижений */
.achievements-container {
    position: fixed;
    top: 5px; /* Отступ сверху */
    right: 15px; /* Отступ справа */
    z-index: 2000; /* Поверх большинства элементов */
    display: flex;
    flex-direction: column; /* Достижения друг под другом */
    gap: 10px; /* Отступ между уведомлениями */
    pointer-events: none; /* Не перехватывает клики мыши */
    max-width: 280px; /* Макс ширина уведомления */
}

/* Стиль для всплывающего достижения */
.achievement-popup {
    background: linear-gradient(135deg, #1e2033, #373b59); /* Градиент фона */
    border: 2px solid #ff8c00; /* Оранжевая рамка */
    border-radius: 12px; /* Скругление углов */
    padding: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); /* Тень */
    display: flex;
    align-items: center; /* Выравнивание по центру */
    gap: 10px; /* Отступ между иконкой и текстом */
    transform: translateX(120%); /* Начальное положение за экраном */
    opacity: 0; /* Начальная прозрачность */
    transition: transform 0.5s ease, opacity 0.5s ease; /* Анимация появления */
    pointer-events: auto; /* Всплывающее окно может перехватывать события (если нужно) */
    max-width: 100%;
}

.achievement-popup.show {
    transform: translateX(0); /* Конечное положение на экране */
    opacity: 1; /* Полная непрозрачность */
}

.achievement-popup .achievement-icon {
    width: 40px;
    height: 40px;
    min-width: 40px; /* Фиксированный размер */
    background: linear-gradient(135deg, #ff0080, #ff8c00); /* Яркий градиент */
    border-radius: 50%; /* Круглая иконка */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px; /* Размер эмодзи */
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); /* Тень для текста */
}

.achievement-popup .achievement-content {
    flex: 1; /* Занимает оставшееся место */
}

.achievement-popup .achievement-title {
    font-family: 'Press Start 2P', cursive; /* Пиксельный шрифт */
    font-size: 12px;
    color: #fff;
    margin: 0 0 5px 0; /* Отступ снизу */
    text-shadow: 1px 1px 0 #000; /* Тень */
    line-height: 1.2;
}

.achievement-popup .achievement-description {
    font-size: 11px;
    color: #ddd; /* Светло-серый */
    margin: 0;
    line-height: 1.2;
    opacity: 0.9; /* Немного прозрачности */
}

/* Анимация свечения для иконки */
@keyframes glow {
    0% { box-shadow: 0 0 5px rgba(255, 140, 0, 0.7); }
    50% { box-shadow: 0 0 15px rgba(255, 140, 0, 0.9); }
    100% { box-shadow: 0 0 5px rgba(255, 140, 0, 0.7); }
}

/* Применяем свечение только к разблокированным иконкам */
.achievement-icon.unlocked-icon-glow {
    animation: glow 2s infinite;
}
.achievement-popup .achievement-icon {
     animation: glow 2s infinite; /* Свечение для всплывающего окна */
}

/* Меню достижений */
.achievements-menu {
    position: fixed; /* Поверх всего */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(30, 32, 51, 0.97); /* Почти непрозрачный фон */
    z-index: 3000; /* Выше всего остального */
    display: none; /* Скрыто по умолчанию */
    flex-direction: column;
    overflow: hidden; /* Чтобы внутренний скролл работал */
    overscroll-behavior: contain; /* Предотвращаем скролл body под меню */
}

.achievements-menu.active {
    display: flex; /* Показываем меню */
}

.achievements-header {
    display: flex;
    justify-content: space-between; /* Заголовок слева, кнопка справа */
    align-items: center;
    padding: 15px;
    background: linear-gradient(90deg, #ff0080, #ff8c00); /* Градиент шапки */
    border-bottom: 2px solid rgba(255, 255, 255, 0.1); /* Разделитель */
    flex-shrink: 0; /* Шапка не сжимается */
}

.achievements-title {
    font-family: 'Press Start 2P', cursive;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    margin: 0;
    font-size: 16px;
}

.achievements-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px; /* Размер крестика */
    font-weight: bold;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.achievements-close:hover {
    background-color: rgba(0, 0, 0, 0.2); /* Фон при наведении */
}

.achievements-stats {
    padding: 15px;
    background-color: rgba(0, 0, 0, 0.2); /* Полупрозрачный фон */
    display: flex;
    justify-content: space-around;
    align-items: center;
    flex-shrink: 0; /* Блок статистики не сжимается */
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.stats-item {
    text-align: center;
    min-width: 80px;
}

.stats-value {
    font-family: 'Press Start 2P', cursive;
    font-size: 18px;
    color: #ff8c00; /* Оранжевый цвет */
    margin: 0 0 5px 0;
}

.stats-label {
    font-size: 12px;
    color: #ddd;
    margin: 0;
}

.achievements-content {
    flex: 1; /* Занимает все оставшееся место */
    overflow-y: auto; /* Включаем прокрутку */
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Адаптивная сетка */
    gap: 15px; /* Отступы между карточками */
    align-content: start; /* Карточки начинаются сверху */
     /* Стилизация скроллбара */
     scrollbar-width: thin; /* Firefox */
     scrollbar-color: #ff8c00 #555; /* Firefox - цвет ползунка и трека */
}
.achievements-content::-webkit-scrollbar {
  width: 8px;
}
.achievements-content::-webkit-scrollbar-track {
  background: #373b59; /* Фон трека */
  border-radius: 4px;
}
.achievements-content::-webkit-scrollbar-thumb {
  background-color: #ff8c00; /* Цвет ползунка */
  border-radius: 4px;
  border: 2px solid #373b59; /* Отступ ползунка от краев трека */
}


.achievement-card {
    background: linear-gradient(135deg, #2a2d45, #373b59); /* Темный фон */
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1); /* Слегка видимая рамка */
    transition: transform 0.2s, box-shadow 0.2s;
}

.achievement-card:hover {
    transform: translateY(-3px); /* Небольшой подъем при наведении */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Тень при наведении */
}

.achievement-card .achievement-icon {
    filter: grayscale(100%); /* Черно-белая иконка для заблокированных */
    animation: none; /* Убираем анимацию */
    opacity: 0.5; /* Полупрозрачная */
}

.achievement-card.unlocked .achievement-icon {
    filter: none; /* Цветная иконка */
    opacity: 1; /* Непрозрачная */
    /* animation: glow 2s infinite; Убираем постоянное свечение из меню */
}
/* Добавляем свечение иконке только при наведении на разблокированную карточку */
.achievement-card.unlocked:hover .achievement-icon {
     animation: glow 2s infinite;
}


.achievement-card.unlocked {
    background: linear-gradient(135deg, #3a3d55, #474b69); /* Чуть светлее фон для разблокированных */
    border: 1px solid rgba(255, 140, 0, 0.3); /* Оранжевая рамка */
}

.achievement-card .achievement-content {
    flex: 1;
}

.achievement-card .achievement-title {
    font-size: 13px;
    margin-bottom: 5px;
    color: #ccc; /* Серый для заблокированных */
}
.achievement-card.unlocked .achievement-title {
     color: #fff; /* Белый для разблокированных */
}


.achievement-card .achievement-description {
    font-size: 11px;
    color: #888; /* Темно-серый для заблокированных */
}
.achievement-card.unlocked .achievement-description {
     color: #ddd; /* Светлее для разблокированных */
}

.achievement-card .achievement-date {
    font-size: 10px;
    color: #777;
    margin-top: 5px;
    display: none; /* Скрыта по умолчанию */
}

.achievement-card.unlocked .achievement-date {
    display: block; /* Показываем дату для разблокированных */
    color: #ffae42; /* Светло-оранжевый для даты */
}

.achievement-card .achievement-progress {
    width: 100%;
    height: 5px;
    background-color: rgba(255, 255, 255, 0.1); /* Фон прогресс-бара */
    border-radius: 3px;
    margin-top: 5px;
    overflow: hidden;
    display: none; /* Скрываем прогресс по умолчанию */
}
/* Показываем прогресс только если он не завершен */
.achievement-card:not(.unlocked) .achievement-progress {
     display: block;
}


.achievement-card .achievement-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff0080, #ff8c00); /* Градиент прогресса */
    width: 0%; /* Начальная ширина */
    transition: width 0.3s ease;
    border-radius: 3px;
}

/* Для секретных недостигнутых достижений */
.achievement-card.secret:not(.unlocked) .achievement-title {
    color: #aaa; /* Цвет текста для секретного */
}
.achievement-card.secret:not(.unlocked) .achievement-description {
     color: #777;
}
.achievement-card.secret:not(.unlocked) .achievement-icon {
     opacity: 0.3;
}


/* Кнопка "Достижения" в навигации */
.nav-button[title="Достижения"] {
    position: relative; /* Для позиционирования значка */
}

.achievements-notification {
    position: absolute;
    top: -5px; /* Положение значка */
    right: -5px;
    background-color: #ff0080; /* Яркий цвет */
    color: white;
    font-size: 10px; /* Размер текста */
    width: 16px; /* Размер значка */
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    opacity: 0; /* Скрыт по умолчанию */
    transform: scale(0); /* Скрыт по умолчанию */
    transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.3s; /* Анимация появления */
    pointer-events: none;
    border: 1px solid rgba(0,0,0,0.3); /* Тонкая рамка */
}

.achievements-notification.active {
    opacity: 1; /* Показать */
    transform: scale(1); /* Показать */
}

/* Адаптивность для маленьких экранов */
@media (max-width: 600px) {
    .achievements-content {
        grid-template-columns: 1fr; /* Одна колонка */
    }

    .achievements-stats {
        flex-wrap: wrap; /* Перенос статистики */
        gap: 10px;
        padding: 10px;
    }
     .stats-item {
        min-width: 70px; /* Уменьшаем мин. ширину */
    }
     .stats-value {
        font-size: 16px;
    }
     .stats-label {
        font-size: 11px;
    }


    .achievement-popup {
        max-width: 250px; /* Уменьшаем ширину уведомления */
        padding: 8px;
        gap: 8px;
    }
    .achievement-popup .achievement-icon {
        width: 35px;
        height: 35px;
        min-width: 35px;
        font-size: 18px;
    }
    .achievement-popup .achievement-title {
         font-size: 11px;
    }
    .achievement-popup .achievement-description {
         font-size: 10px;
    }

}
</style>

<div class="achievements-container" id="achievements-container"></div> <div class="achievements-menu" id="achievements-menu"> <div class="achievements-header">
        <h2 class="achievements-title">ДОСТИЖЕНИЯ</h2>
        <button class="achievements-close" id="achievements-close" title="Закрыть">&times;</button>
    </div>
    <div class="achievements-stats">
        <div class="stats-item">
            <div class="stats-value" id="stats-completed">0</div>
            <div class="stats-label">Получено</div>
        </div>
        <div class="stats-item">
            <div class="stats-value" id="stats-total">0</div>
            <div class="stats-label">Всего</div>
        </div>
        <div class="stats-item">
            <div class="stats-value" id="stats-percentage">0%</div>
            <div class="stats-label">Завершено</div>
        </div>
    </div>
    <div class="achievements-content" id="achievements-content">
        </div>
</div>

<script>
// Класс для управления системой достижений
class AchievementSystem {
    constructor() {

// Инициализируем звук, но не пытаемся его сразу загрузить
this.achievementSound = null;
this.soundInitialized = false;

        // Список достижений
        this.achievements = [
             { id: 'first_game', icon: '🎮', title: 'Первая игра', description: 'Запустите любую игру впервые', secret: false, game: null, condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'game_master', icon: '👑', title: 'Игровой мастер', description: 'Сыграйте в 10 разных игр', secret: false, game: null, condition: null, progress: { current: 0, max: 10 } },
             { id: 'collector', icon: '⭐', title: 'Коллекционер', description: 'Добавьте 5 игр в избранное', secret: false, game: null, condition: null, progress: { current: 0, max: 5 } },
             { id: 'mario_fan', icon: '🍄', title: 'Фанат Марио', description: 'Сыграйте в игру про Марио', secret: false, game: ['mario', 'super_mario_bros_2_rus', 'super_mario_bros_3_e_t_rus_by_2r_team_2r_team', 'mario_bros'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'contra_commando', icon: '🔫', title: 'Коммандо', description: 'Сыграйте в игру из серии Contra', secret: false, game: ['contra', 'contra_force', 'super_contra'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'ninja_warrior', icon: '🥷', title: 'Ниндзя-воин', description: 'Сыграйте в игру о ниндзя', secret: false, game: ['ninja_gaiden', 'shadow_of_the_ninja'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'tank_commander', icon: '🏆', title: 'Танковый командир', description: 'Сыграйте в Battle City', secret: false, game: ['battle_city', 'tank_1990'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'megaman_hero', icon: '🤖', title: 'Герой Мегамен', description: 'Сыграйте в любую игру про Мегамена', secret: false, game: ['mega_man', 'mega_man2', 'mega_man3', 'mega_man4', 'mega_man5', 'megaman6'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'turtles_fan', icon: '🐢', title: 'Фанат черепашек', description: 'Сыграйте в игру из серии TMNT', secret: false, game: ['teenage_mutant_ninja_turtles_rus', 'teenage_mutant_ninja_turtles_ii_the_arcade_game', 'teenage_mutant_ninja_turtles_tournament_fighters', 'teenage_manhattan'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'disney_adventurer', icon: '🦆', title: 'Дисней-приключенец', description: 'Сыграйте в игру по мультфильму Disney', secret: false, game: ['duck_tales', 'duck_tales_2', 'chip_n_dale_rescue_rangers_rus', 'chip_n_dale_rescue_rangers_2_u_t_rus_by_shedevr', 'darkwing_duck_u', 'talespin'], condition: () => true, progress: { current: 0, max: 1 } },
             { id: 'night_gamer', icon: '🌙', title: 'Ночной геймер', description: 'Играйте между 23:00 и 5:00', secret: true, game: null, condition: () => { const hour = new Date().getHours(); return hour >= 23 || hour < 5; }, progress: { current: 0, max: 1 } },
             { id: 'explorer', icon: '🔍', title: 'Исследователь', description: 'Просмотрите описания 20 разных игр', secret: false, game: null, condition: null, progress: { current: 0, max: 20 } }, // Изменено условие
             { id: 'early_bird', icon: '🐦', title: 'Ранняя пташка', description: 'Играйте между 5:00 и 8:00 утра', secret: true, game: null, condition: () => { const hour = new Date().getHours(); return hour >= 5 && hour < 8; }, progress: { current: 0, max: 1 } },
             { id: 'weekend_warrior', icon: '🎭', title: 'Выходной воин', description: 'Играйте в выходные дни', secret: false, game: null, condition: () => { const day = new Date().getDay(); return day === 0 || day === 6; }, progress: { current: 0, max: 1 } },
             { id: 'tetris_champion', icon: '🧩', title: 'Мастер блоков', description: 'Сыграйте в Tetris', secret: false, game: ['tetris'], condition: () => true, progress: { current: 0, max: 1 } }
        ];

// Добавляем инициализацию звука при первом клике пользователя
document.addEventListener('click', () => {
    if (!this.soundInitialized) {
        this.achievementSound = new Audio('data/sound/achievement.mp3');
        this.achievementSound.volume = 0.7;
        this.soundInitialized = true;
    }
}, { once: true }); // обработчик сработает только один раз

        // Статусы разблокировки { achievementId: { unlocked: true, unlockTime: 'ISOString' } }
        this.unlockedAchievements = this.loadUnlockedAchievements();
        // Список просмотренных игр (для достижения Explorer) [gameId1, gameId2, ...]
        this.viewedGames = this.loadViewedGames();
        // Список запущенных игр (для достижения Game Master) [gameId1, gameId2, ...]
        this.playedGames = this.loadPlayedGames();
        // Новые достижения (не просмотренные в меню) [achId1, achId2, ...]
        this.newAchievements = this.loadNewAchievements();

        // Элементы DOM
        this.container = document.getElementById('achievements-container');
        this.menu = document.getElementById('achievements-menu');
        this.menuContent = document.getElementById('achievements-content');
        this.statsCompleted = document.getElementById('stats-completed');
        this.statsTotal = document.getElementById('stats-total');
        this.statsPercentage = document.getElementById('stats-percentage');

        // Инициализация
        this.initEvents();
        this.renderAchievementsMenu(); // Первоначальная отрисовка меню
        this.updateNotificationBadge(); // Показать значок, если есть новые
        this.checkInitialProgress(); // Проверка прогресса при загрузке
         console.log("AchievementSystem initialized."); // Отладка
    }

    // Загрузка данных из localStorage с обработкой ошибок
    loadData(key, defaultValue) {
        try {
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : defaultValue;
        } catch (e) {
            console.error(`Ошибка при загрузке ${key}:`, e);
            return defaultValue;
        }
    }
    // Сохранение данных в localStorage с обработкой ошибок
    saveData(key, data) {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            console.error(`Ошибка при сохранении ${key}:`, e);
             // Можно добавить уведомление пользователю об ошибке сохранения
             // alert("Ошибка сохранения прогресса достижений. Возможно, память браузера переполнена.");
        }
    }

    loadUnlockedAchievements() { return this.loadData('unlockedAchievements', {}); }
    saveUnlockedAchievements() { this.saveData('unlockedAchievements', this.unlockedAchievements); }
    loadViewedGames() { return this.loadData('viewedGames', []); }
    saveViewedGames() { this.saveData('viewedGames', this.viewedGames); }
    loadPlayedGames() { return this.loadData('playedGames', []); }
    savePlayedGames() { this.saveData('playedGames', this.playedGames); }
    loadNewAchievements() { return this.loadData('newAchievements', []); }
    saveNewAchievements() { this.saveData('newAchievements', this.newAchievements); }


    // Обновление счетчика на кнопке достижений
    updateNotificationBadge() {
        const achievementsButton = document.querySelector('.navigation .nav-button[title="Достижения"]');
        if (!achievementsButton) return; // Выходим, если кнопки нет

        let badge = achievementsButton.querySelector('.achievements-notification');

        if (this.newAchievements.length > 0) {
            if (!badge) { // Если бейджа нет, создаем его
                badge = document.createElement('div');
                badge.className = 'achievements-notification';
                achievementsButton.appendChild(badge);
            }
            badge.textContent = this.newAchievements.length;
            // Используем requestAnimationFrame для плавной анимации
            requestAnimationFrame(() => {
                 badge.classList.add('active');
            });
        } else if (badge) { // Если бейдж есть, но достижений нет
            badge.classList.remove('active');
             // Можно удалить бейдж после анимации исчезновения
             // setTimeout(() => badge.remove(), 300);
        }
    }

    // Инициализация всех событий
    initEvents() {
         // Закрытие меню
         const closeButton = document.getElementById('achievements-close');
         if (closeButton) {
            closeButton.addEventListener('click', () => this.hideAchievementsMenu());
         } else {
             console.error("Кнопка закрытия меню достижений не найдена!");
         }


         // Добавление кнопки достижений в навигацию, если её ещё нет
         const navigation = document.querySelector('.navigation');
         let achievementsButton = document.querySelector('.nav-button[title="Достижения"]'); // Проверяем, есть ли уже

         if (navigation && !achievementsButton) {
             achievementsButton = document.createElement('button');
             achievementsButton.className = 'nav-button';
             achievementsButton.title = 'Достижения';
             achievementsButton.innerHTML = '🏅'; // Иконка
             navigation.appendChild(achievementsButton);
             console.log("Кнопка 'Достижения' добавлена в навигацию.");
         }
         // Добавляем слушатель клика на кнопку (даже если она уже была)
         if (achievementsButton) {
             achievementsButton.addEventListener('click', () => this.showAchievementsMenu());
         } else {
             console.error("Не удалось найти или создать кнопку 'Достижения'.");
         }


        // Слушаем кастомные события
        document.addEventListener('gameStarted', (e) => {
            if (e.detail && e.detail.gameId !== undefined) { // Проверяем наличие gameId (может быть null)
                 console.log("Event 'gameStarted' received with id:", e.detail.gameId);
                 this.onGameStarted(e.detail.gameId);
            } else {
                 console.warn("Event 'gameStarted' received without gameId in detail.");
                 // Вызываем onGameStarted с null, чтобы сработало 'first_game'
                 this.onGameStarted(null);
            }
        });
        document.addEventListener('gameViewed', (e) => {
            if (e.detail && e.detail.gameId) {
                 console.log("Event 'gameViewed' received with id:", e.detail.gameId);
                 this.onGameViewed(e.detail.gameId);
            } else {
                 console.warn("Event 'gameViewed' received without gameId in detail.");
            }
        });
        document.addEventListener('favoriteAdded', (e) => {
             console.log("Event 'favoriteAdded' received.");
             this.checkCollectorAchievement(); // Проверяем достижение коллекционера
        });

        // Периодическая проверка достижений по времени
        this.checkTimeBasedAchievements(); // Проверяем сразу
        setInterval(() => {
            this.checkTimeBasedAchievements();
        }, 60000); // Проверяем каждую минуту
    }

     // Проверка прогресса достижений при загрузке страницы
     checkInitialProgress() {
         this.checkCollectorAchievement();
         this.checkGameMasterAchievement();
         this.checkExplorerAchievement();
         console.log("Initial achievement progress checked.");
     }


    // Обработка события запуска игры
    onGameStarted(gameId) {
        console.log("AchievementSystem: onGameStarted processing for gameId:", gameId);

        // 1. Всегда проверяем "Первая игра"
        // Для этого достижения прогресс не нужен, просто разблокируем
        const firstGameAch = this.achievements.find(a => a.id === 'first_game');
        if (firstGameAch && !this.isUnlocked('first_game')) {
             this.unlockAchievement('first_game');
        }

        // 2. Если ID игры определен, проверяем специфичные для игры достижения
        if (gameId) {
            this.achievements.forEach(achievement => {
                // Проверяем, что достижение привязано к игре, не разблокировано и игра совпадает
                if (achievement.game && Array.isArray(achievement.game) && !this.isUnlocked(achievement.id) && achievement.game.includes(gameId)) {
                    // Проверяем условие (обычно () => true для game-specific)
                    if (typeof achievement.condition === 'function' && achievement.condition()) {
                        console.log(`AchievementSystem: Unlocking specific achievement: ${achievement.id} for game ${gameId}`);
                        // Увеличиваем прогресс или сразу разблокируем
                        if(achievement.progress.max === 1) {
                             this.unlockAchievement(achievement.id);
                        } else {
                             // Логика для прогресса, если нужна (здесь нет таких)
                        }
                    }
                }
            });

            // 3. Добавляем игру в список *уникальных* запущенных
            const playedSet = new Set(this.playedGames); // Используем Set для уникальности
            if (!playedSet.has(gameId)) {
                this.playedGames.push(gameId);
                this.savePlayedGames();
                console.log(`AchievementSystem: Added ${gameId} to played games. Total unique: ${this.playedGames.length}`);
                // Проверяем достижение "Игровой мастер" ПОСЛЕ добавления
                this.checkGameMasterAchievement();
            }
        } else {
            console.log("AchievementSystem: gameId is null, skipping game-specific checks and played games update.");
        }

        // 4. Проверяем достижения, основанные на времени
        this.checkTimeBasedAchievements();

        // 5. Обновляем рендер меню, чтобы отразить возможные изменения прогресса
        this.renderAchievementsMenu();
    }


    // Обработка события просмотра игры
    onGameViewed(gameId) {
         console.log("AchievementSystem: onGameViewed processing for gameId:", gameId);
         if (!gameId) return;

        // Добавляем игру в список *уникальных* просмотренных
         const viewedSet = new Set(this.viewedGames);
         if (!viewedSet.has(gameId)) {
            this.viewedGames.push(gameId);
            this.saveViewedGames();
             console.log(`AchievementSystem: Added ${gameId} to viewed games. Total unique: ${this.viewedGames.length}`);
             // Проверяем достижение "Исследователь"
            this.checkExplorerAchievement();
             // Обновляем рендер меню
             this.renderAchievementsMenu();
        }
    }

     // Проверка, разблокировано ли достижение
     isUnlocked(achievementId) {
         return this.unlockedAchievements[achievementId] ? true : false;
     }

    // Проверка достижения "Игровой мастер"
    checkGameMasterAchievement() {
        const achievement = this.achievements.find(a => a.id === 'game_master');
        if (achievement && !this.isUnlocked(achievement.id)) { // Проверяем только если не разблокировано
            // Обновляем текущий прогресс на основе длины массива уникальных игр
            achievement.progress.current = Math.min(this.playedGames.length, achievement.progress.max);
            console.log(`AchievementSystem: Game Master progress: ${achievement.progress.current}/${achievement.progress.max}`);
            if (achievement.progress.current >= achievement.progress.max) {
                this.unlockAchievement('game_master');
            }
            // Обновляем отображение прогресса в меню (даже если не разблокировано)
            this.updateAchievementProgressDisplay('game_master');
        } else if (achievement && this.isUnlocked(achievement.id)) {
             // Если уже разблокировано, убедимся, что прогресс = max
             achievement.progress.current = achievement.progress.max;
             this.updateAchievementProgressDisplay('game_master');
        }
    }

    // Проверка достижения "Коллекционер"
    checkCollectorAchievement() {
         const achievement = this.achievements.find(a => a.id === 'collector');
         if (achievement && !this.isUnlocked(achievement.id)) { // Проверяем только если не разблокировано
             const favorites = favoritesManager.getFavorites(); // Получаем актуальный список
             achievement.progress.current = Math.min(favorites.length, achievement.progress.max);
             console.log(`AchievementSystem: Collector progress: ${achievement.progress.current}/${achievement.progress.max}`);
             if (achievement.progress.current >= achievement.progress.max) {
                 this.unlockAchievement('collector');
             }
             this.updateAchievementProgressDisplay('collector');
         } else if (achievement && this.isUnlocked(achievement.id)) {
             achievement.progress.current = achievement.progress.max;
             this.updateAchievementProgressDisplay('collector');
         }
    }


    // Проверка достижения "Исследователь"
    checkExplorerAchievement() {
         const achievement = this.achievements.find(a => a.id === 'explorer');
         if (achievement && !this.isUnlocked(achievement.id)) { // Проверяем только если не разблокировано
             const uniqueViewedCount = new Set(this.viewedGames).size;
             achievement.progress.current = Math.min(uniqueViewedCount, achievement.progress.max);
             console.log(`AchievementSystem: Explorer progress: ${achievement.progress.current}/${achievement.progress.max}`);
             if (achievement.progress.current >= achievement.progress.max) {
                 this.unlockAchievement('explorer');
             }
             this.updateAchievementProgressDisplay('explorer');
         } else if (achievement && this.isUnlocked(achievement.id)) {
             achievement.progress.current = achievement.progress.max;
             this.updateAchievementProgressDisplay('explorer');
         }
    }


    // Проверка достижений, основанных на времени
    checkTimeBasedAchievements() {
        this.achievements.forEach(achievement => {
            // Проверяем только time-based и если еще не разблокировано
            if (['night_gamer', 'early_bird', 'weekend_warrior'].includes(achievement.id) && !this.isUnlocked(achievement.id)) {
                if (typeof achievement.condition === 'function' && achievement.condition()) {
                     console.log(`AchievementSystem: Condition met for time-based achievement: ${achievement.id}`);
                     this.unlockAchievement(achievement.id);
                }
            }
        });
    }

    // Разблокирование достижения
    unlockAchievement(achievementId) {
        if (this.isUnlocked(achievementId)) { // Двойная проверка
            return;
        }
        const achievement = this.achievements.find(a => a.id === achievementId);
        if (!achievement) {
            console.error(`Попытка разблокировать несуществующее достижение: ${achievementId}`);
            return;
        }

        console.log(`AchievementSystem: Unlocking achievement '${achievement.title}' (${achievementId})`);
        const unlockTime = new Date().toISOString();
        this.unlockedAchievements[achievementId] = { unlocked: true, unlockTime: unlockTime };
        // Устанавливаем прогресс в максимум
        achievement.progress.current = achievement.progress.max;

        // Добавляем в список *уникальных* новых достижений
         if (!this.newAchievements.includes(achievementId)) {
            this.newAchievements.push(achievementId);
         }

        // Сохраняем
        this.saveUnlockedAchievements();
        this.saveNewAchievements();

        // Обновляем UI
        this.updateNotificationBadge();
        this.showAchievementPopup(achievement);
        this.renderAchievementsMenu(); // Перерисовываем меню с обновленным статусом
    }

    // Обновление отображения прогресса достижения в меню
    updateAchievementProgressDisplay(achievementId) {
        const achievement = this.achievements.find(a => a.id === achievementId);
        if (!achievement) return;

        const card = this.menuContent ? this.menuContent.querySelector(`.achievement-card[data-id="${achievementId}"]`) : null;
        if (card) {
            const progressBar = card.querySelector('.achievement-progress-bar');
            const progressContainer = card.querySelector('.achievement-progress');
            if (progressBar && progressContainer) {
                 const isAchUnlocked = this.isUnlocked(achievementId);
                 // Показываем прогресс только если НЕ разблокировано и есть прогресс
                 if (!isAchUnlocked && achievement.progress.max > 1) {
                     const percent = achievement.progress.max > 0 ? (achievement.progress.current / achievement.progress.max) * 100 : 0;
                     progressBar.style.width = `${percent}%`;
                     progressContainer.style.display = 'block'; // Показываем контейнер
                 } else {
                     progressBar.style.width = '0%'; // Сбрасываем для разблокированных или max=1
                     progressContainer.style.display = 'none'; // Скрываем контейнер
                 }
            }
             // Обновляем дату, если разблокировано
             const dateElement = card.querySelector('.achievement-date');
             if (dateElement) {
                 const isAchUnlocked = this.isUnlocked(achievementId);
                 if(isAchUnlocked && this.unlockedAchievements[achievementId]?.unlockTime) {
                     const unlockDate = new Date(this.unlockedAchievements[achievementId].unlockTime);
                     const unlockDateStr = unlockDate.toLocaleDateString() + ' ' + unlockDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                     dateElement.textContent = 'Получено: ' + unlockDateStr;
                     dateElement.style.display = 'block';
                 } else {
                     dateElement.style.display = 'none';
                 }
             }

        } else {
             // console.warn(`Не удалось найти карточку для обновления прогресса: ${achievementId}`);
        }
    }


    // Показ всплывающего уведомления о достижении
    showAchievementPopup(achievement) {
// Воспроизводим звук только если он инициализирован
if (this.achievementSound && this.soundInitialized) {
    try {
        this.achievementSound.currentTime = 0;
        this.achievementSound.play().catch(error => {
            console.warn('Не удалось воспроизвести звук достижения:', error);
        });
    } catch (e) {
        console.error('Ошибка при воспроизведении звука достижения:', e);
    }
}

         if (!this.container) {
             console.error("Контейнер для достижений не найден!");
             return;
         }
        // Создаем элемент
        const popup = document.createElement('div');
        popup.className = 'achievement-popup';
        popup.innerHTML = `
            <div class="achievement-icon">${achievement.icon}</div>
            <div class="achievement-content">
                <div class="achievement-title">${achievement.title}</div>
                <div class="achievement-description">${achievement.description}</div>
            </div>
        `;
        this.container.appendChild(popup);

        // Анимация появления и исчезновения
        requestAnimationFrame(() => {
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
                popup.addEventListener('transitionend', () => {
                     if (popup.parentNode === this.container) { // Проверка, что элемент еще существует
                         this.container.removeChild(popup);
                     }
                }, { once: true }); // Удаляем после завершения анимации исчезновения
            }, 4000); // Показываем 4 секунды
        });
    }


    // Отображение меню достижений
    showAchievementsMenu() {
         if (!this.menu) {
             console.error("Элемент меню достижений не найден!");
             return;
         }
        this.renderAchievementsMenu(); // Обновляем перед показом
        this.menu.classList.add('active');
        document.body.style.overflow = 'hidden'; // Блокируем скролл фона

        // Очищаем список новых достижений и сохраняем
        this.newAchievements = [];
        this.saveNewAchievements();
        this.updateNotificationBadge(); // Обновляем значок (он должен исчезнуть)
         console.log("Achievements menu shown.");
    }

    // Скрытие меню достижений
    hideAchievementsMenu() {
         if (!this.menu) return;
        this.menu.classList.remove('active');
        document.body.style.overflow = ''; // Возвращаем скролл фона
         console.log("Achievements menu hidden.");
    }

    // Отрисовка всех достижений в меню
    renderAchievementsMenu() {
         if (!this.menuContent || !this.statsCompleted || !this.statsTotal || !this.statsPercentage) {
             // console.error("Не найдены все элементы для рендеринга меню достижений.");
             // Не выводим ошибку постоянно, т.к. рендер может вызываться до полного DOM ready
             return;
         }

        // Сортируем: сначала разблокированные (по дате), потом заблокированные (по порядку)
         const sortedAchievements = [...this.achievements].sort((a, b) => {
             const unlockedA = this.isUnlocked(a.id);
             const unlockedB = this.isUnlocked(b.id);

             if (unlockedA && !unlockedB) return -1; // Разблокированные выше
             if (!unlockedA && unlockedB) return 1;  // Заблокированные ниже
             if (unlockedA && unlockedB) {
                 // Сортируем разблокированные по дате (сначала новые)
                 const timeA = new Date(this.unlockedAchievements[a.id]?.unlockTime || 0).getTime();
                 const timeB = new Date(this.unlockedAchievements[b.id]?.unlockTime || 0).getTime();
                 return timeB - timeA; // Новые выше
             }
             // Если оба заблокированы, оставляем исходный порядок (или можно по title)
             return 0;
              // return a.title.localeCompare(b.title); // Сортировка заблокированных по алфавиту
         });


        // Очищаем контейнер
        this.menuContent.innerHTML = '';

        // Добавляем карточки
        sortedAchievements.forEach(achievement => {
            const isAchUnlocked = this.isUnlocked(achievement.id);

            let title = achievement.title;
            let description = achievement.description;
            let icon = achievement.icon;

            if (achievement.secret && !isAchUnlocked) {
                title = "???";
                description = "Секретное достижение";
                icon = '❓'; // Иконка для секрета
            }

            const card = document.createElement('div');
            card.className = `achievement-card ${isAchUnlocked ? 'unlocked' : ''} ${achievement.secret ? 'secret' : ''}`;
            card.dataset.id = achievement.id;

            const current = achievement.progress.current;
            const max = achievement.progress.max;
            const percent = max > 0 ? (current / max) * 100 : (isAchUnlocked ? 100 : 0);

            const unlockDate = isAchUnlocked ? new Date(this.unlockedAchievements[achievement.id]?.unlockTime || Date.now()) : null;
            const unlockDateStr = unlockDate ? unlockDate.toLocaleDateString() + ' ' + unlockDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

            card.innerHTML = `
                <div class="achievement-icon">${icon}</div>
                <div class="achievement-content">
                    <div class="achievement-title">${title}</div>
                    <div class="achievement-description">${description}</div>
                    <div class="achievement-date" style="display: ${isAchUnlocked ? 'block' : 'none'}">${isAchUnlocked ? 'Получено: ' + unlockDateStr : ''}</div>
                    <div class="achievement-progress" style="display: ${!isAchUnlocked && max > 1 ? 'block' : 'none'}">
                        <div class="achievement-progress-bar" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
            this.menuContent.appendChild(card);
        });

        // Обновляем статистику
        const unlockedCount = Object.keys(this.unlockedAchievements).length;
        const totalCount = this.achievements.length;
        const percentage = totalCount > 0 ? Math.floor((unlockedCount / totalCount) * 100) : 0;

        this.statsCompleted.textContent = unlockedCount;
        this.statsTotal.textContent = totalCount;
        this.statsPercentage.textContent = `${percentage}%`;
    }

} // --- Конец класса AchievementSystem ---

// Инициализация системы достижений при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Создаем глобальный объект системы достижений СРАЗУ
    window.achievementSystem = new AchievementSystem();

    // Проверяем начальный прогресс достижений, которые могли быть выполнены ранее
    // (например, на основе данных в localStorage)
     if (window.achievementSystem) {
         window.achievementSystem.checkInitialProgress();
     } else {
         console.error("Не удалось создать объект achievementSystem!");
     }

});
</script>

</body>
</html>