<!DOCTYPE html>
<html>
    <head>
        <title>Dendy Emulator для Telegram</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <style>
            body, html {
                height: 100%;
                background-color: #1E1E1E;
                color: white;
                margin: 0;
                padding: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                overflow: hidden;
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
            }

            .container {
                width: 100%;
                max-width: 800px;
                padding: 10px;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            #header {
                text-align: center;
                padding: 10px 0;
                width: 100%;
            }

            #header h1 {
                margin: 0 0 10px 0;
                font-size: 28px;
            }

            #header p {
                margin: 0;
                font-size: 16px;
                color: #bbb;
            }

            .logo {
                width: 80px;
                height: 80px;
                margin-bottom: 10px;
            }

            #gameSelect {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 15px;
                background-color: #2A2A2A;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 15px;
                box-sizing: border-box;
            }

            #uploadBox {
                width: 100%;
                height: 120px;
                border: 2px dashed #555;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 15px;
                background-color: #333;
                transition: all 0.3s;
                cursor: pointer;
                position: relative;
                box-sizing: border-box;
            }

            #uploadBox:hover, #uploadBox[drag], #uploadBox:active {
                border-color: #0088CC;
                background-color: #383838;
            }

            #fileInput {
                position: absolute;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
                z-index: 10;
            }

            #uploadText {
                font-size: 16px;
                color: #aaa;
                text-align: center;
                padding: 0 15px;
            }

            #gameLibrary {
                width: 100%;
                margin-bottom: 15px;
            }

            .gameLibraryTitle {
                font-size: 18px;
                margin-bottom: 10px;
                color: #ddd;
                text-align: center;
            }

            #gamesList {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
                width: 100%;
            }

            .gameCard {
                background-color: #333;
                border-radius: 8px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .gameCard:hover, .gameCard:active {
                background-color: #444;
                transform: translateY(-2px);
            }

            .gameIcon {
                width: 60px;
                height: 60px;
                margin-bottom: 5px;
                border-radius: 4px;
                background-color: #222;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 8px auto;
                font-weight: bold;
                color: #0088CC;
            }

            .gameTitle {
                font-size: 14px;
                color: #ddd;
                word-break: break-word;
            }

            #display {
                width: 100%;
                height: calc(100vh - 160px);
                max-height: 600px;
                background-color: #000;
                border-radius: 8px;
                overflow: hidden;
                position: relative;
            }

            #game {
                width: 100%;
                height: 100%;
            }

            select, button {
                padding: 12px;
                margin: 8px 0;
                width: 100%;
                max-width: 300px;
                font-family: inherit;
                font-size: 16px;
                background-color: #0088CC;
                color: white;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                touch-action: manipulation;
            }

            button:hover, button:active {
                background-color: #0077B5;
            }

            select {
                background-color: #333;
                color: #ddd;
            }

            select:hover, select:active {
                background-color: #444;
            }

            .hidden {
                display: none !important;
            }

            #backButton {
                position: fixed;
                top: 15px;
                left: 15px;
                background-color: rgba(0,0,0,0.7);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 15px;
                cursor: pointer;
                z-index: 100;
                display: none;
                font-size: 14px;
                font-weight: bold;
                max-width: unset;
                width: auto;
            }

            #backButton:hover, #backButton:active {
                background-color: rgba(0,0,0,0.9);
            }
            
            #fullscreenButton {
                position: fixed;
                top: 15px;
                right: 15px;
                background-color: rgba(0,0,0,0.7);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px 15px;
                cursor: pointer;
                z-index: 100;
                display: none;
                font-size: 14px;
                font-weight: bold;
                max-width: unset;
                width: auto;
            }

            #fullscreenButton:hover, #fullscreenButton:active {
                background-color: rgba(0,0,0,0.9);
            }
            
            /* Стили для полноэкранного режима */
            .fullscreen-mode #display {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                max-height: none;
                z-index: 1000;
                border-radius: 0;
            }
            
            .fullscreen-mode #backButton {
                z-index: 1001;
            }
            
            .fullscreen-mode #fullscreenButton {
                z-index: 1001;
            }

            /* Стили для мобильных устройств */
            @media (max-width: 768px) {
                .container {
                    padding: 8px;
                }
                
                #header {
                    padding-top: 45px; /* Добавляем отступ сверху для заголовка в мобильной версии */
                }
                
                #header h1 {
                    font-size: 24px;
                }
                
                #header p {
                    font-size: 14px;
                }
                
                #gameSelect {
                    padding: 12px;
                }
                
                #uploadBox {
                    height: 100px;
                }
                
                #uploadText {
                    font-size: 14px;
                }
                
                #gamesList {
                    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                    gap: 8px;
                }
                
                .gameCard {
                    padding: 8px;
                }
                
                .gameIcon {
                    width: 45px;
                    height: 45px;
                }
                
                .gameTitle {
                    font-size: 12px;
                }
                
                #display {
                    height: calc(100vh - 120px);
                }
                
                #backButton, #fullscreenButton {
                    padding: 8px 12px;
                    font-size: 13px;
                }
            }
            
            /* Стили для маленьких мобильных устройств */
            @media (max-width: 480px) {
                #header h1 {
                    font-size: 22px;
                }
                
                #gamesList {
                    grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
                    gap: 6px;
                }
                
                .gameIcon {
                    width: 40px;
                    height: 40px;
                }
                
                .gameTitle {
                    font-size: 11px;
                }
                
                #uploadBox {
                    height: 90px;
                }
                
                #uploadText {
                    font-size: 13px;
                }
                
                #display {
                    height: calc(100vh - 100px);
                }
                
                #backButton {
                    padding: 8px 12px;
                    font-size: 12px;
                }
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div id="header">
                <h1>Dendy Emulator</h1>
                <p>Играйте в классические игры прямо в Telegram</p>
            </div>

            <div id="gameSelect">
                <div id="uploadBox">
                    <input type="file" id="fileInput" accept=".nes,.fds,.unif,.unf">
                    <div id="uploadText">
                        <strong>Загрузите ROM-файл</strong><br>
                        Перетащите файл или нажмите здесь
                    </div>
                </div>

                <div id="gameLibrary">
                    <div class="gameLibraryTitle">Выберите игру из библиотеки:</div>
                    <div id="gamesList"></div>
                </div>
            </div>

            <div id="display" class="hidden">
                <div id="game"></div>
            </div>
        </div>
        
        <div id="orientationMessage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; box-sizing: border-box;">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 2H7C5.9 2 5 2.9 5 4v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path>
                <path d="M12 18h.01"></path>
            </svg>
            <h2 style="margin: 15px 0;">Для лучшего опыта</h2>
            <p style="font-size: 16px; margin: 0 0 20px 0;">Поверните устройство в горизонтальное положение для более комфортной игры</p>
        </div>

        <button id="backButton">← Назад</button>
        <button id="fullscreenButton">На весь экран</button>
        
        <!-- Невидимая кнопка для отладки, в случае проблем с остановкой эмулятора -->
        <button id="forceStopButton" style="display: none; position: fixed; bottom: 10px; right: 10px; z-index: 1000; background-color: red;">Принудительная остановка</button>

        <script>
            // Конфигурация
            const enableDebug = false;
            const enableThreads = false;
            const defaultCore = "nes"; // NES/Dendy
            
            // Элементы DOM
            const fileInput = document.getElementById('fileInput');
            const uploadBox = document.getElementById('uploadBox');
            const gameSelect = document.getElementById('gameSelect');
            const display = document.getElementById('display');
            const backButton = document.getElementById('backButton');
            const fullscreenButton = document.getElementById('fullscreenButton');
            const gamesList = document.getElementById('gamesList');
            
            // Обработка перетаскивания файлов
            uploadBox.ondragover = (e) => {
                e.preventDefault();
                uploadBox.setAttribute("drag", true);
            };
            
            uploadBox.ondragleave = () => {
                uploadBox.removeAttribute("drag");
            };
            
            uploadBox.ondrop = (e) => {
                e.preventDefault();
                uploadBox.removeAttribute("drag");
                
                if (e.dataTransfer.files.length > 0) {
                    handleRomFile(e.dataTransfer.files[0]);
                }
            };
            
            // Обработка выбора файла
            fileInput.onchange = () => {
                if (fileInput.files.length > 0) {
                    handleRomFile(fileInput.files[0]);
                }
            };
            
            // Кнопка возврата к выбору игр
            backButton.onclick = () => {
                // Выход из полноэкранного режима, если активен
                if (document.body.classList.contains('fullscreen-mode')) {
                    toggleFullscreen();
                }
                
                // Остановка эмулятора перед возвратом в меню
                stopEmulator();
                
                // Возврат к выбору игр
                display.classList.add('hidden');
                gameSelect.classList.remove('hidden');
                backButton.style.display = 'none';
                fullscreenButton.style.display = 'none';
            };
            
            // Функция переключения полноэкранного режима
            function toggleFullscreen() {
                document.body.classList.toggle('fullscreen-mode');
                
                if (document.body.classList.contains('fullscreen-mode')) {
                    fullscreenButton.textContent = 'Выйти из полноэкрана';
                    
                    // Запрашиваем полноэкранный режим браузера, если доступно
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log("Ошибка: не удалось перейти в полноэкранный режим", err);
                        });
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    }
                } else {
                    fullscreenButton.textContent = 'На весь экран';
                    
                    // Выходим из полноэкранного режима браузера
                    if (document.exitFullscreen) {
                        document.exitFullscreen().catch(err => {
                            console.log("Ошибка: не удалось выйти из полноэкранного режима", err);
                        });
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            }
            
            // Обработчик кнопки полноэкранного режима
            fullscreenButton.addEventListener('click', toggleFullscreen);
            
            // Обработчик для выхода из полноэкранного режима по кнопке Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
                    toggleFullscreen();
                }
            });
            
            // Обработчик для события изменения полноэкранного режима браузера
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement && document.body.classList.contains('fullscreen-mode')) {
                    // Если пользователь вышел из полноэкранного режима через системные кнопки браузера
                    document.body.classList.remove('fullscreen-mode');
                    fullscreenButton.textContent = 'На весь экран';
                }
            });
            
            // Обработчик для WebKit
            document.addEventListener('webkitfullscreenchange', function() {
                if (!document.webkitFullscreenElement && document.body.classList.contains('fullscreen-mode')) {
                    document.body.classList.remove('fullscreen-mode');
                    fullscreenButton.textContent = 'На весь экран';
                }
            });
            
            // Обработчик для MS browsers
            document.addEventListener('MSFullscreenChange', function() {
                if (!document.msFullscreenElement && document.body.classList.contains('fullscreen-mode')) {
                    document.body.classList.remove('fullscreen-mode');
                    fullscreenButton.textContent = 'На весь экран';
                }
            });
            
            // Полная остановка и очистка эмулятора
            function stopEmulator() {
                // Останавливаем все аудиоконтексты
                stopAllAudio();
                
                // Удаляем предыдущий экземпляр эмулятора
                const gameContainer = document.getElementById('game');
                while (gameContainer.firstChild) {
                    gameContainer.removeChild(gameContainer.firstChild);
                }
                
                // Удаляем скрипт эмулятора
                const oldScript = document.getElementById('emulatorScript');
                if (oldScript) {
                    oldScript.remove();
                }
                
                // Очищаем глобальные переменные эмулятора
                window.EJS_player = null;
                window.EJS_gameUrl = null;
                window.EJS_core = null;
                window.EJS_pathtodata = null;
                window.EJS_startOnLoaded = null;
                window.EJS_onGameStart = null;
                
                // Важно: останавливаем эмулятор если он существует
                if (window.EJS_emulator) {
                    try {
                        if (typeof window.EJS_emulator.pause === 'function') {
                            window.EJS_emulator.pause();
                        }
                        if (typeof window.EJS_emulator.stop === 'function') {
                            window.EJS_emulator.stop();
                        }
                        if (typeof window.EJS_emulator.destroy === 'function') {
                            window.EJS_emulator.destroy();
                        }
                        window.EJS_emulator = null;
                    } catch (e) {
                        console.error("Ошибка при остановке эмулятора:", e);
                    }
                }
                
                // Принудительно освобождаем память
                if (window.gc) {
                    window.gc();
                }
            }
            
            // Остановка всех звуков
            function stopAllAudio() {
                // Останавливаем все аудиоконтексты
                try {
                    // Поиск всех аудиоконтекстов на странице
                    const audioElements = document.querySelectorAll('audio');
                    audioElements.forEach(audio => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.remove();
                    });
                    
                    // Если эмулятор использует Web Audio API
                    if (window.AudioContext || window.webkitAudioContext) {
                        // Пробуем найти и остановить все аудиоконтексты
                        if (window.EJS_emulator && window.EJS_emulator.audioContext) {
                            try {
                                window.EJS_emulator.audioContext.close();
                            } catch (e) {
                                console.error("Ошибка при закрытии аудиоконтекста:", e);
                            }
                        }
                    }
                } catch (e) {
                    console.error("Ошибка при остановке аудио:", e);
                }
            }
            
            // Обработка ROM-файла
            function handleRomFile(file) {
                const fileName = file.name;
                const parts = fileName.split(".");
                const extension = parts.pop().toLowerCase();
                const gameName = parts.join(".");
                
                // Проверяем поддерживаемые форматы для Dendy/NES
                if (["fds", "nes", "unif", "unf"].includes(extension)) {
                    loadGame(file, gameName, defaultCore);
                } else {
                    alert("Этот формат файла не поддерживается. Пожалуйста, загрузите ROM в формате .nes, .fds, .unif или .unf");
                }
            }
            
            // Загрузка игры из ROM-файла или URL
            function loadGame(romFile, gameName, core) {
                // Останавливаем предыдущий экземпляр эмулятора если он есть
                stopEmulator();
                
                // Скрываем выбор игры и показываем эмулятор
                gameSelect.classList.add('hidden');
                display.classList.remove('hidden');
                backButton.style.display = 'block';
                fullscreenButton.style.display = 'block';
                
                // Конфигурируем эмулятор
                window.EJS_player = "#game";
                window.EJS_gameName = gameName;
                window.EJS_biosUrl = "";
                window.EJS_gameUrl = romFile; // Может быть как File, так и URL
                window.EJS_core = core;
                window.EJS_pathtodata = "data/";
                window.EJS_startOnLoaded = true;
                window.EJS_DEBUG_XX = enableDebug;
                window.EJS_disableDatabases = true;
                window.EJS_threads = enableThreads;
                window.EJS_onGameStart = function() {
                    // Можно добавить логику для Telegram
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                    
                    // Проверяем ориентацию при запуске игры
                    checkOrientation();
                };
                
                // Загружаем эмулятор
                const script = document.createElement("script");
                script.id = "emulatorScript";
                script.src = "data/loader.js";
                document.body.appendChild(script);
            }
            
            // Загрузка игры по URL
            function loadGameFromUrl(romUrl, gameName) {
                loadGame(romUrl, gameName, defaultCore);
            }
            
            // Инициализация библиотеки игр
            function initGameLibrary() {
                // Библиотека игр с реальными путями к ROM-файлам
                const libraryGames = [
                    { id: "mario", title: "Super Mario Bros", romUrl: "roms/Mario.nes" },
                    { id: "contra", title: "Contra", romUrl: "roms/Contra.nes" },
                    { id: "battle_city", title: "Battle City", romUrl: "roms/Battle City.nes" },
                    { id: "duck_hunt", title: "Duck Hunt", romUrl: "roms/Duck Hunt.nes" },
                    { id: "tetris", title: "Tetris", romUrl: "roms/Tetris.nes" },
                    { id: "ninja_gaiden", title: "Ninja Gaiden", romUrl: "roms/Ninja Gaiden.nes" }
                ];
                
                // Очищаем список игр
                gamesList.innerHTML = '';
                
                // Заполняем список игр
                libraryGames.forEach(game => {
                    const gameCard = document.createElement('div');
                    gameCard.className = 'gameCard';
                    gameCard.innerHTML = `
                        <div class="gameIcon">NES</div>
                        <div class="gameTitle">${game.title}</div>
                    `;
                    
                    // Обработка клика и тача по игре
                    gameCard.onclick = () => {
                        loadGameFromUrl(game.romUrl, game.title);
                    };
                    // Добавляем поддержку касаний для мобильных устройств
                    gameCard.addEventListener('touchend', (e) => {
                        e.preventDefault(); // Предотвращаем стандартное поведение
                        loadGameFromUrl(game.romUrl, game.title);
                    });
                    
                    gamesList.appendChild(gameCard);
                });
            }
            
            // Интеграция с Telegram WebApp
            function initTelegramWebApp() {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    // Инициализация WebApp
                    tg.expand();
                    tg.enableClosingConfirmation();
                    
                    // Устанавливаем цвета в соответствии с темой Telegram
                    if (tg.colorScheme === 'dark') {
                        document.body.style.backgroundColor = '#1E1E1E';
                    } else {
                        document.body.style.backgroundColor = '#F5F5F5';
                        document.body.style.color = '#000';
                        
                        // Дополнительные стили для светлой темы
                        document.querySelectorAll('.gameCard').forEach(card => {
                            card.style.backgroundColor = '#E0E0E0';
                        });
                        
                        document.querySelectorAll('.gameTitle').forEach(title => {
                            title.style.color = '#333';
                        });
                        
                        document.querySelectorAll('.gameIcon').forEach(icon => {
                            icon.style.backgroundColor = '#CCC';
                        });
                        
                        document.getElementById('gameSelect').style.backgroundColor = '#EFEFEF';
                        document.getElementById('uploadBox').style.backgroundColor = '#E0E0E0';
                        document.getElementById('uploadText').style.color = '#555';
                    }
                    
                    // Адаптация под безопасную зону экрана
                    if (tg.isExpanded) {
                        const safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tg-viewport-stable-height')) || 0;
                        if (safeAreaBottom) {
                            document.body.style.paddingBottom = safeAreaBottom + 'px';
                        }
                    }
                }
            }
            
            // Обработка изменения размеров экрана
            window.addEventListener('resize', function() {
                // Адаптация высоты области отображения игры при изменении размера окна
                if (!display.classList.contains('hidden')) {
                    const viewportHeight = window.innerHeight;
                    const headerHeight = document.getElementById('header').offsetHeight;
                    display.style.height = (viewportHeight - headerHeight - 20) + 'px';
                }
            });
            
            // Проверка ориентации экрана
            function checkOrientation() {
                const orientationMessage = document.getElementById('orientationMessage');
                
                // Определяем, находится ли устройство в портретной ориентации
                const isPortrait = window.innerHeight > window.innerWidth;
                
                // Показываем сообщение только если устройство в портретной ориентации и эмулятор запущен
                if (isPortrait && !display.classList.contains('hidden') && window.innerWidth < 768) {
                    orientationMessage.style.display = 'flex';
                    setTimeout(() => {
                        orientationMessage.style.opacity = '1';
                    }, 100);
                } else {
                    orientationMessage.style.display = 'none';
                    orientationMessage.style.opacity = '0';
                }
            }
            
            // Обработка изменения ориентации
            window.addEventListener('orientationchange', checkOrientation);
            window.addEventListener('resize', checkOrientation);
            
            // Автоматическая адаптация под размер экрана
            function adjustForScreenSize() {
                // Адаптация размера игровых карточек под ширину экрана
                const container = document.querySelector('.container');
                const containerWidth = container.offsetWidth;
                
                if (containerWidth < 400) {
                    document.getElementById('gamesList').style.gridTemplateColumns = 'repeat(auto-fill, minmax(85px, 1fr))';
                } else if (containerWidth < 600) {
                    document.getElementById('gamesList').style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                } else {
                    document.getElementById('gamesList').style.gridTemplateColumns = 'repeat(auto-fill, minmax(140px, 1fr))';
                }
                
               // При запуске игры проверяем ориентацию
                if (!display.classList.contains('hidden')) {
                    checkOrientation();
                }
            }
            
            // Инициализация при загрузке страницы
            window.onload = function() {
                initGameLibrary();
                initTelegramWebApp();
                adjustForScreenSize();
                
                // Добавляем обработчик для закрытия сообщения об ориентации при тапе
                document.getElementById('orientationMessage').addEventListener('click', function() {
                    this.style.display = 'none';
                });
                
                // Добавляем обработчик для кнопки принудительной остановки (для отладки)
                document.getElementById('forceStopButton').addEventListener('click', function() {
                    stopEmulator();
                    alert('Эмулятор принудительно остановлен');
                });
                
                // Обработка закрытия окна/вкладки для очистки ресурсов
                window.addEventListener('beforeunload', function() {
                    stopEmulator();
                });
                
                // Регистрируем обработчик событий Visibility API
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden && !display.classList.contains('hidden')) {
                        // Если страница скрыта и эмулятор запущен, приостанавливаем его
                        if (window.EJS_emulator && typeof window.EJS_emulator.pause === 'function') {
                            window.EJS_emulator.pause();
                        }
                    }
                });
            };
        </script>
    </body>
</html>