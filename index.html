<!DOCTYPE html>
<html>
    <head>
        <title>Dendy Emulator для Telegram</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body, html {
                height: 100%;
                background-color: #1E1E1E;
                color: white;
                margin: 0;
                padding: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            }

            body {
                overflow: hidden;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .container {
                width: 100%;
                max-width: 800px;
                padding: 10px;
                box-sizing: border-box;
            }

            #header {
                text-align: center;
                padding: 10px 0;
            }

            .logo {
                width: 80px;
                height: 80px;
                margin-bottom: 10px;
            }

            #gameSelect {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 15px;
                background-color: #2A2A2A;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 15px;
            }

            #uploadBox {
                width: 100%;
                height: 120px;
                border: 2px dashed #555;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 15px;
                background-color: #333;
                transition: all 0.3s;
                cursor: pointer;
                position: relative;
            }

            #uploadBox:hover, #uploadBox[drag] {
                border-color: #0088CC;
                background-color: #383838;
            }

            #fileInput {
                position: absolute;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
            }

            #uploadText {
                font-size: 16px;
                color: #aaa;
                text-align: center;
            }

            #gameLibrary {
                width: 100%;
                margin-bottom: 15px;
            }

            .gameLibraryTitle {
                font-size: 18px;
                margin-bottom: 10px;
                color: #ddd;
            }

            #gamesList {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
                width: 100%;
            }

            .gameCard {
                background-color: #333;
                border-radius: 8px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
            }

            .gameCard:hover {
                background-color: #444;
                transform: translateY(-2px);
            }

            .gameIcon {
                width: 60px;
                height: 60px;
                margin-bottom: 5px;
                border-radius: 4px;
                background-color: #222;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 8px auto;
            }

            .gameTitle {
                font-size: 14px;
                color: #ddd;
                word-break: break-word;
            }

            #display {
                width: 100%;
                height: calc(100vh - 160px);
                max-height: 600px;
                background-color: #000;
                border-radius: 8px;
                overflow: hidden;
            }

            #game {
                width: 100%;
                height: 100%;
            }

            select, button {
                padding: 12px;
                margin: 8px 0;
                width: 100%;
                max-width: 300px;
                font-family: inherit;
                font-size: 16px;
                background-color: #0088CC;
                color: white;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
            }

            button:hover {
                background-color: #0077B5;
            }

            select {
                background-color: #333;
                color: #ddd;
            }

            select:hover {
                background-color: #444;
            }

            .hidden {
                display: none !important;
            }

            #backButton {
                position: fixed;
                top: 15px;
                left: 15px;
                background-color: rgba(0,0,0,0.5);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 8px 15px;
                cursor: pointer;
                z-index: 100;
                display: none;
                font-size: 14px;
                font-weight: bold;
            }

            #backButton:hover {
                background-color: rgba(0,0,0,0.7);
            }

            /* Стили для мобильных устройств */
            @media (max-width: 768px) {
                #gamesList {
                    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
                }
                
                .gameIcon {
                    width: 50px;
                    height: 50px;
                }
                
                .gameTitle {
                    font-size: 13px;
                }
                
                #display {
                    height: calc(100vh - 140px);
                }
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div id="header">
                <h1>Dendy Emulator</h1>
                <p>Играйте в классические игры прямо в Telegram</p>
            </div>

            <div id="gameSelect">
                <div id="uploadBox">
                    <input type="file" id="fileInput" accept=".nes,.fds,.unif,.unf">
                    <div id="uploadText">
                        <strong>Загрузите ROM-файл</strong><br>
                        Перетащите файл или нажмите здесь
                    </div>
                </div>

                <div id="gameLibrary">
                    <div class="gameLibraryTitle">Выберите игру из библиотеки:</div>
                    <div id="gamesList"></div>
                </div>
            </div>

            <div id="display" class="hidden">
                <div id="game"></div>
            </div>
        </div>

        <button id="backButton">← Назад к выбору игр</button>

        <script>
            // Конфигурация
            const enableDebug = false;
            const enableThreads = false;
            const defaultCore = "nes"; // NES/Dendy
            
            // Элементы DOM
            const fileInput = document.getElementById('fileInput');
            const uploadBox = document.getElementById('uploadBox');
            const gameSelect = document.getElementById('gameSelect');
            const display = document.getElementById('display');
            const backButton = document.getElementById('backButton');
            const gamesList = document.getElementById('gamesList');
            
            // Обработка перетаскивания файлов
            uploadBox.ondragover = (e) => {
                e.preventDefault();
                uploadBox.setAttribute("drag", true);
            };
            
            uploadBox.ondragleave = () => {
                uploadBox.removeAttribute("drag");
            };
            
            uploadBox.ondrop = (e) => {
                e.preventDefault();
                uploadBox.removeAttribute("drag");
                
                if (e.dataTransfer.files.length > 0) {
                    handleRomFile(e.dataTransfer.files[0]);
                }
            };
            
            // Обработка выбора файла
            fileInput.onchange = () => {
                if (fileInput.files.length > 0) {
                    handleRomFile(fileInput.files[0]);
                }
            };
            
            // Кнопка возврата к выбору игр
            backButton.onclick = () => {
                display.classList.add('hidden');
                gameSelect.classList.remove('hidden');
                backButton.style.display = 'none';
                
                // Удаляем предыдущий экземпляр эмулятора
                const gameContainer = document.getElementById('game');
                while (gameContainer.firstChild) {
                    gameContainer.removeChild(gameContainer.firstChild);
                }
                
                // Удаляем скрипт эмулятора
                const oldScript = document.getElementById('emulatorScript');
                if (oldScript) {
                    oldScript.remove();
                }
            };
            
            // Обработка ROM-файла
            function handleRomFile(file) {
                const fileName = file.name;
                const parts = fileName.split(".");
                const extension = parts.pop().toLowerCase();
                const gameName = parts.join(".");
                
                // Проверяем поддерживаемые форматы для Dendy/NES
                if (["fds", "nes", "unif", "unf"].includes(extension)) {
                    loadGame(file, gameName, defaultCore);
                } else {
                    alert("Этот формат файла не поддерживается. Пожалуйста, загрузите ROM в формате .nes, .fds, .unif или .unf");
                }
            }
            
            // Загрузка игры из ROM-файла или URL
            function loadGame(romFile, gameName, core) {
                // Скрываем выбор игры и показываем эмулятор
                gameSelect.classList.add('hidden');
                display.classList.remove('hidden');
                backButton.style.display = 'block';
                
                // Конфигурируем эмулятор
                window.EJS_player = "#game";
                window.EJS_gameName = gameName;
                window.EJS_biosUrl = "";
                window.EJS_gameUrl = romFile; // Может быть как File, так и URL
                window.EJS_core = core;
                window.EJS_pathtodata = "data/";
                window.EJS_startOnLoaded = true;
                window.EJS_DEBUG_XX = enableDebug;
                window.EJS_disableDatabases = true;
                window.EJS_threads = enableThreads;
                window.EJS_onGameStart = function() {
                    // Можно добавить логику для Telegram
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                };
                
                // Загружаем эмулятор
                const script = document.createElement("script");
                script.id = "emulatorScript";
                script.src = "data/loader.js";
                document.body.appendChild(script);
            }
            
            // Загрузка игры по URL
            function loadGameFromUrl(romUrl, gameName) {
                loadGame(romUrl, gameName, defaultCore);
            }
            
            // Инициализация библиотеки игр
            function initGameLibrary() {
                // Библиотека игр с реальными путями к ROM-файлам
                const libraryGames = [
                    { id: "mario", title: "Super Mario Bros", romUrl: "roms/Mario.nes" },
                    { id: "contra", title: "Contra", romUrl: "roms/Contra.nes" },
                    { id: "battle_city", title: "Battle City", romUrl: "roms/Battle City.nes" },
                    { id: "duck_hunt", title: "Duck Hunt", romUrl: "roms/Duck Hunt.nes" },
                    { id: "tetris", title: "Tetris", romUrl: "roms/Tetris.nes" },
                    { id: "ninja_gaiden", title: "Ninja Gaiden", romUrl: "roms/Ninja Gaiden.nes" }
                ];
                
                // Очищаем список игр
                gamesList.innerHTML = '';
                
                // Заполняем список игр
                libraryGames.forEach(game => {
                    const gameCard = document.createElement('div');
                    gameCard.className = 'gameCard';
                    gameCard.innerHTML = `
                        <div class="gameIcon">NES</div>
                        <div class="gameTitle">${game.title}</div>
                    `;
                    
                    // Обработка клика по игре
                    gameCard.onclick = () => {
                        loadGameFromUrl(game.romUrl, game.title);
                    };
                    
                    gamesList.appendChild(gameCard);
                });
            }
            
            // Интеграция с Telegram WebApp
            function initTelegramWebApp() {
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    // Инициализация WebApp
                    tg.expand();
                    
                    // Устанавливаем цвета в соответствии с темой Telegram
                    if (tg.colorScheme === 'dark') {
                        document.body.style.backgroundColor = '#1E1E1E';
                    } else {
                        document.body.style.backgroundColor = '#F5F5F5';
                        document.body.style.color = '#000';
                        // Здесь можно добавить больше стилей для светлой темы
                    }
                    
                    // Можно добавить больше интеграций с Telegram WebApp
                }
            }
            
            // Инициализация при загрузке страницы
            window.onload = function() {
                initGameLibrary();
                initTelegramWebApp();
            };
        </script>
    </body>
</html>